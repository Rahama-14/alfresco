<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>

<beans>
    
    <!-- Bootstrap Records Management Models -->
    
    <bean id="org_alfresco_module_dod5015_dictionaryBootstrap" parent="dictionaryModelBootstrap" depends-on="dictionaryBootstrap">
        <property name="models">
            <list>
                <value>alfresco/module/org_alfresco_module_dod5015/model/recordsModel.xml</value>
                <value>alfresco/module/org_alfresco_module_dod5015/model/dod5015Model.xml</value>
            </list>
        </property>
    </bean>
    <bean id="org_alfresco_module_dod5015_customModelsRepositoryLocation" class="org.alfresco.repo.dictionary.RepositoryLocation">
        <property name="path">
            <value>/app:company_home/app:dictionary/cm:records_management</value>
        </property>
        <property name="queryLanguage">
            <value>xpath</value>
        </property>
    </bean>
    <bean id="org_alfresco_module_dod5015_dictionaryRepositoryBootstrap" parent="dictionaryRepositoryBootstrap">
      <property name="repositoryModelsLocations">
         <list>
             <ref bean="org_alfresco_module_dod5015_customModelsRepositoryLocation" />
         </list>
      </property>
   </bean>
    
    <!-- Bootstrap the permission model -->
    
    <bean id="org_alfresco_module_dod5015_permissionBootstrap" parent="permissionModelBootstrap">
        <property name="model" value="alfresco/module/org_alfresco_module_dod5015/model/recordsPermissionModel.xml"/>
    </bean>
    
    <!-- Bootstrap records management data -->
    
    <bean id="org_alfresco_module_dod5015_bootstrapData" class="org.alfresco.repo.module.ImporterModuleComponent" parent="module.baseComponent">
        <property name="moduleId" value="org_alfresco_module_dod5015"/>
        <property name="name" value="org_alfresco_module_dod5015_bootstrapData"/>
        <property name="description" value="Bootstrap records management data"/>
        <property name="sinceVersion" value="1.0"/>
        <property name="appliesFromVersion" value="1.0"/>
        <!-- Data properties -->
        <property name="importer" ref="spacesBootstrap"/>
        <property name="bootstrapViews">
            <list>
                <props>
                    <prop key="path">/${spaces.company_home.childname}/${spaces.dictionary.childname}</prop>
                    <prop key="location">alfresco/module/org_alfresco_module_dod5015/bootstrap/RMDataDictionaryBootstrap.xml</prop>
                </props>
            </list>
        </property>
    </bean>
    
    <!-- Import fixed permission definitions for RM -->
    <import resource="classpath:alfresco/module/org_alfresco_module_dod5015/rm-public-services-security-context.xml"/>
    
    <!-- Import the RM service's -->
    <import resource="classpath:alfresco/module/org_alfresco_module_dod5015/rm-service-context.xml"/>
    
    <!-- Import capabilities -->
    <import resource="classpath:alfresco/module/org_alfresco_module_dod5015/rm-capabilities-context.xml"/>
    
    <!-- Import the RM action's -->
    <import resource="classpath:alfresco/module/org_alfresco_module_dod5015/rm-action-context.xml"/>
    
    <!-- RM Script API -->
    
    <bean id="scriptRecordsManagementService" parent="baseJavaScriptExtension" class="org.alfresco.module.org_alfresco_module_dod5015.jscript.ScriptRecordsManagmentService">
        <property name="extensionName">
            <value>rmService</value>
        </property>
        <property name="recordsManagementServiceRegistry" ref="RecordsManagementServiceRegistry"/>
    </bean>
    
    <!-- Event types -->
    
    <bean id="rmEventResourceBundles" class="org.alfresco.i18n.ResourceBundleBootstrapComponent">
        <property name="resourceBundles">
            <list>
                <value>alfresco.module.org_alfresco_module_dod5015.rm-events</value>
            </list>
        </property>
    </bean>
    
    <bean id="rmEventType" init-method="init" abstract="true">
        <property name="recordsManagementEventService" ref="recordsManagementEventService"/>
    </bean>
    
    <bean id="rmEventType.simple" class="org.alfresco.module.org_alfresco_module_dod5015.event.SimpleRecordsManagementEventTypeImpl" parent="rmEventType"/>
    
    <!-- Scheduled actions -->
    
    <!-- NotifyOfRecordsDueForReview Job -->
   <bean id="scheduledNotifyOfRecordsDueForReviewJobDetail" class="org.springframework.scheduling.quartz.JobDetailBean">
      <property name="jobClass">
         <value>org.alfresco.module.org_alfresco_module_dod5015.job.NotifyOfRecordsDueForReviewJob</value>
      </property>
      <property name="jobDataAsMap">
         <map>
            <entry key="nodeService">
               <ref bean="nodeService" />
            </entry>
            <entry key="searchService">
               <ref bean="searchService" />
            </entry>
            <entry key="transactionService">
               <ref bean="transactionService" />
            </entry>
         </map>
      </property>
   </bean>
   
   <bean id="scheduledNotifyOfRecordsDueForReviewJobTrigger" class="org.alfresco.util.CronTriggerBean">
      <property name="jobDetail">
         <ref bean="scheduledNotifyOfRecordsDueForReviewJobDetail" />
      </property>
      <property name="scheduler">
         <ref bean="schedulerFactory" />
      </property>
      <!-- Run daily at half past 2 in the morning-->
      <property name="cronExpression">
         <value>0 30 2 * * ?</value>
         <!-- Every 30s for testing. <value>0,30 * * ? * *</value> -->
      </property>
   </bean>
   

    <!-- Disposition Lifecycle Job -->
   <bean id="scheduledDispositionLifecyceleJobDetail" class="org.springframework.scheduling.quartz.JobDetailBean">
      <property name="jobClass">
         <value>org.alfresco.module.org_alfresco_module_dod5015.job.DispositionLifecycleJob</value>
      </property>
      <property name="jobDataAsMap">
         <map>
            <entry key="nodeService">
               <ref bean="nodeService" />
            </entry>
            <entry key="searchService">
               <ref bean="searchService" />
            </entry>
            <entry key="recordsManagementActionService">
               <ref bean="recordsManagementActionService" />
            </entry>
            <entry key="transactionService">
               <ref bean="transactionService" />
            </entry>
         </map>
      </property>
   </bean>

   <bean id="scheduledDispositionLifecyceleJobTrigger" class="org.alfresco.util.CronTriggerBean">
      <property name="jobDetail">
         <ref bean="scheduledDispositionLifecyceleJobDetail" />
      </property>
      <property name="scheduler">
         <ref bean="schedulerFactory" />
      </property>
      <!-- Run daily at half past 3 in the morning-->
      <property name="cronExpression">
         <value>0 30 3 * * ?</value>
      </property>
   </bean>
	

    
    <!--
    <bean id="scheduledDispositionJobDetail" class="org.springframework.scheduling.quartz.JobDetailBean">
    <property name="jobClass">
    <value>org.alfresco.module.org_alfresco_module_dod5015.action.ScheduledDispositionJob</value>
    </property>
    <property name="jobDataAsMap">
    <map>
    <entry key="nodeService">
    <ref bean="nodeService" />
    </entry>
    <entry key="searchService">
    <ref bean="searchService"/>
    </entry>
    <entry key="recordsManagementActionService">
    <ref bean="recordsManagementActionService" />
    </entry>
    </map>
    </property>
    </bean>
    
    <bean id="scheduledDispositionTrigger" class="org.alfresco.util.CronTriggerBean">
    <property name="jobDetail">
    <ref bean="scheduledDispositionJobDetail" />
    </property>
    <property name="scheduler">
    <ref bean="schedulerFactory" />
    </property>
    <property name="cronExpression">
    <value>0,30 * * ? * *</value>
    </property>
    </bean>
    -->
    
    <bean id="RMModuleComponent" class="org.alfresco.module.org_alfresco_module_dod5015.RecordsManagementModuleComponent" parent="module.baseComponent">
        <!-- init caveatConfig behaviours  -->
        <property name="executeOnceOnly" value="false"/>
        
        <property name="moduleId" value="org_alfresco_module_dod5015"/>
        <property name="caveatConfigService" ref="caveatConfigService"/>
        <property name="customEmailMappingService" ref="customEmailMappingService"/>
        
    </bean>
    
    <!-- RM caveats -->
    <!-- Caveat read veto is now enforced via the security wrappers for RM -->
    
    <bean id="caveatConfigService" class="org.alfresco.module.org_alfresco_module_dod5015.caveat.RMCaveatConfigServiceImpl">
        <property name="policyComponent" ref="policyComponent"/>
        <property name="contentService" ref="contentService"/>
        <property name="dictionaryService" ref="dictionaryService"/>
        <property name="namespaceService" ref="namespaceService"/>
        <property name="authorityService" ref="authorityService"/>
        <property name="personService" ref="personService"/>
        <property name="nodeService" ref="nodeService"/>
        <property name="recordsManagementAdminService" ref = "recordsManagementAdminService" />
        
    </bean>
    
    <bean id="rmListOfValuesContraintInit" class="org.alfresco.module.org_alfresco_module_dod5015.caveat.RMListOfValuesConstraint">
        <property name="caveatConfigService" ref="caveatConfigService"/>
    </bean>
         
    <!-- Site service transaction bean -->
    <bean id="CaveatConfigService_transaction" class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
        <property name="transactionAttributes">
            <props>
                <prop key="*">${server.transaction.mode.default}</prop>
            </props>
        </property>
    </bean>
    
    <bean id="CaveatConfigService" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyInterfaces">
            <list>
                <value>org.alfresco.module.org_alfresco_module_dod5015.caveat.RMCaveatConfigService</value>
            </list>
        </property>
        <property name="targetName">
            <value>caveatConfigService</value>
        </property>
        <property name="interceptorNames">
            <list>
                <idref local="CaveatConfigService_transaction"/>
                <idref bean="AuditMethodInterceptor"/>
                <idref bean="exceptionTranslator"/>
            </list>
        </property>
    </bean>
    
    
    <!-- Java script interface for rm caveat config-->
    <bean id="rmConfigServiceScript" parent="baseJavaScriptExtension" class="org.alfresco.module.org_alfresco_module_dod5015.caveat.ScriptRMCaveatConfigService">
        <property name="extensionName">
            <value>caveatConfig</value>
        </property>
        <property name="caveatConfigService" ref="caveatConfigService"/>
        <property name="authorityService" ref="authorityService"/>
    </bean>
     
    <!-- Form Processor Filters to process RM nodes and types -->
    <bean id="rmNodeFormFilter" parent="baseFormFilter"
          class="org.alfresco.module.org_alfresco_module_dod5015.forms.RecordsManagementNodeFormFilter">
       <property name="filterRegistry" ref="nodeFilterRegistry" />
       <property name="namespaceService" ref="NamespaceService"/>
       <property name="nodeService" ref="NodeService"/>
       <property name="dictionaryService" ref="DictionaryService" />
       <property name="recordsManagementAdminService" ref="recordsManagementAdminService"/>
    </bean>
    
    <bean id="rmTypeFormFilter" parent="baseFormFilter"
          class="org.alfresco.module.org_alfresco_module_dod5015.forms.RecordsManagementTypeFormFilter">
       <property name="filterRegistry" ref="typeFilterRegistry" />
       <property name="namespaceService" ref="NamespaceService"/>
       <property name="nodeService" ref="NodeService"/>
       <property name="recordsManagementAdminService" ref="recordsManagementAdminService"/>
    </bean>
    
    <!-- Import the RM webscript's -->
    <import resource="classpath:alfresco/module/org_alfresco_module_dod5015/rm-webscript-context.xml"/>
    
    <bean id="customEmailMappingService" 
      class="org.alfresco.module.org_alfresco_module_dod5015.email.CustomEmailMappingServiceImpl" >
      <property name="extracter" ref="extracter.RFC822" />
      <property name="nodeService" ref="nodeService" />
      <property name="contentService" ref="contentService"/>
      <property name="namespacePrefixResolver">
            <ref bean="namespaceService"></ref>
      </property>
      <property name="policyComponent"><ref bean="policyComponent" /></property>
      <property name="transactionService"><ref bean="transactionService" /></property>
   
    </bean>
    
    
    <bean id="CustomEmailMappingService_transaction" class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
        <property name="transactionAttributes">
            <props>
                <prop key="*">${server.transaction.mode.default}</prop>
            </props>
        </property>
    </bean>
    
    <bean id="CustomEmailMappingService_security" class="org.alfresco.repo.security.permissions.impl.AlwaysProceedMethodInterceptor" />
    
    <bean id="CustomEmailMappingService" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyInterfaces">
            <list>
                <value>org.alfresco.module.org_alfresco_module_dod5015.email.CustomEmailMappingService</value>
            </list>
        </property>
        <property name="targetName">
            <value>customEmailMappingService</value>
        </property>
        <property name="interceptorNames">
            <list>
                <idref local="CustomEmailMappingService_transaction"/>
                <idref local="CustomEmailMappingService_security"/>
                <idref bean="AuditMethodInterceptor"/>
                <idref bean="exceptionTranslator"/>
            </list>
        </property>
    </bean>
    
    <!-- REST impl for GET Email Map  -->
    <bean id="webscript.org.alfresco.rma.admin.emailmap.get" class="org.alfresco.module.org_alfresco_module_dod5015.script.EmailMapGet" parent="webscript">
        <property name="customEmailMappingService" ref="CustomEmailMappingService" />
    </bean>
    
    <!-- REST impl for POST Email Map  -->
    <bean id="webscript.org.alfresco.rma.admin.emailmap.post" class="org.alfresco.module.org_alfresco_module_dod5015.script.EmailMapPost" parent="webscript">
        <property name="customEmailMappingService" ref="CustomEmailMappingService" />
    </bean>
    
    <!-- REST impl for PUT Email Map  -->
    <bean id="webscript.org.alfresco.rma.admin.emailmap.put" class="org.alfresco.module.org_alfresco_module_dod5015.script.EmailMapPut" parent="webscript">
        <property name="customEmailMappingService" ref="CustomEmailMappingService" />
    </bean>
    
</beans>
