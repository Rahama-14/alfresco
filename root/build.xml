<project name="alfresco"
         default="build-tomcat" >
   <dirname property="alfresco.basedir" file="${ant.file.alfresco}"/>


   <!-- ****************************************************** -->
   <!-- ************ Initialisation/Configuration ************ -->
   <!-- ****************************************************** -->

   <import file="${alfresco.basedir}/macros.xml" />
   <import file="${alfresco.basedir}/projects.xml" />

   <target name="init">
      <property environment="env" />

      <!-- 
            On UNIX, it's considered very poor form to dump a config file that
            does not start with "." into the user's $HOME directory.  

            On Windows, it's a bit more debatable, but in any event Alfresco 
            config files should always start with "alfresco-...", so the current
            prop file convention needs to be fixed no matter how you slice it.  
            The conditional below is intended to make the transition more graceful 
            until we re-work the build.  
      -->
      <condition property = "alfresco.user.override.properties.file"
                 value    = "${user.home}/.alfresco-user-override.properties"
                 else     = "${user.home}/user-override.properties">
          <available file = "${user.home}/.alfresco-user-override.properties"/>
      </condition>
      <property file      = "${alfresco.user.override.properties.file}" />

      <property file="${alfresco.basedir}/projects/repository/config/alfresco/version.properties" />
      <property file="${alfresco.basedir}/build.properties" />
      <property file="${alfresco.basedir}/shared.properties" />
      
      <echo>user.home = ${user.home}</echo>

      <path id="classpath.compile">
         <fileset dir="${dir.project.3rdparty.lib}">
            <include name="**/*.jar" />
            <!-- Avoid compile-time dependencies against optional components, e.g. log4j -->
            <exclude name="optional/**" />
         </fileset>
         <fileset dir="${dir.projects}">
            <include name="**/${dir.name.build}/${dir.name.dist}/*.jar" />
         </fileset>
         <fileset dir="${dir.modules}">
            <include name="**/${dir.name.lib}/*.jar" />
         </fileset>
         <fileset dir="${dir.modules}">
            <include name="**/${dir.name.build}/${dir.name.dist}/*.jar" />
         </fileset>
      </path>
     <!-- Extension point for overriding -->
      <path id="classpath.compile.extension"/>

      <path id="classpath.unit.test">
         <!--
         <dirset dir="${dir.projects}">
            <include name="**/${dir.name.build}/${dir.name.classes}" />
         </dirset>
         <pathelement location="${user.home}"/>
         <pathelement location="${dir.project.repository.config}"/>
         <pathelement location="${dir.project.webclient.config}"/>
         <pathelement location="${dir.project.deployment.config}"/>
         <pathelement location="${dir.project.remoteapi.config}"/>
         <dirset dir="${dir.projects}">
            <include name="**/${dir.name.source}/${dir.name.test.resources}" />
         </dirset>
         <fileset dir="${dir.project.3rdparty.lib}">
            <include name="**/*.jar" />
         </fileset>
         -->
         <pathelement location="${dir.project.core.classes}" />
         <pathelement location="${dir.project.core.src.java}" />
         <pathelement location="${dir.project.catalinavirtual.classes}" />
         <pathelement location="${dir.project.jlan.classes}" />
         <pathelement location="${dir.project.mbeans.classes}" />
         <pathelement location="${dir.project.jndi.classes}" />
         <pathelement location="${dir.project.deployment.classes}" />
         <pathelement location="${dir.project.linkvalidation.classes}" />
         <pathelement location="${dir.project.remoteapi.classes}" />
         <pathelement location="${dir.project.repository.classes}" />
         <pathelement location="${dir.project.wdrdeployment.classes}" />
         <pathelement location="${dir.project.webframeworkcommons.classes}" />
         <pathelement location="${dir.project.webclient.classes}" />
         <pathelement location="${dir.project.webserviceclient.classes}" />
         
         <pathelement location="${user.home}" />
         <!-- <pathelement location="${alf.build.location.data}"/> -->
         
         <pathelement location="${dir.project.repository.config}" />
         <pathelement location="${dir.project.webclient.config}" />
         <pathelement location="${dir.project.deployment.config}" />
         <pathelement location="${dir.project.linkvalidation.config}" />
         <pathelement location="${dir.project.remoteapi.config}" />
         
         <pathelement location="${dir.project.core}/${dir.name.source}/${dir.name.test.resources}" />
         <pathelement location="${dir.project.remoteapi}/${dir.name.source}/${dir.name.test.resources}" />
         <pathelement location="${dir.project.repository}/${dir.name.source}/${dir.name.test.resources}" />
         <pathelement location="${dir.project.webclient}/${dir.name.source}/${dir.name.test.resources}" />
         
         <pathelement location="${dir.project.3rdparty.lib}/abdera/abdera-core-0.4.0-incubating.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/abdera/abdera-extensions-json-0.4.0-incubating.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/abdera/abdera-i18n-0.4.0-incubating.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/abdera/abdera-parser-0.4.0-incubating.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/abdera/axiom-api-1.2.5.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/abdera/axiom-impl-1.2.5.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/abdera/geronimo-activation_1.0.2_spec-1.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/abdera/stax-api-1.0.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/abdera/wstx-asl-3.2.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/chemistry-tck-atompub-1.0-SNAPSHOT.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-beanutils-1.7.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-codec-1.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-collections-3.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-dbcp-1.2.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-digester-1.6.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-discovery-0.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-el.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-httpclient-3.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-io-1.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-jxpath-1.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-lang-2.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-logging-1.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons/commons-pool-1.4.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/spring-surf/spring-surf-core-1.0.0.CI-SNAPSHOT.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/spring-surf/spring-surf-core-configservice-1.0.0.CI-SNAPSHOT.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/spring-surf/spring-webscripts-1.0.0.CI-SNAPSHOT.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/spring-surf/spring-webscripts-1.0.0.CI-SNAPSHOT-tests.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/spring-surf/spring-surf-1.0.0.CI-SNAPSHOT.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/devenv/mysql-connector-java-5.1.7-bin.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/j2ee/servlet.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/mockito-all-1.8.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/devenv/org.springframework.test-${file.version.springframework}.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/devenv/yguard.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/fop/avalon-framework-4.2.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/fop/batik-all-1.6.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/fop/fop-0.94.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/fop/xmlgraphics-commons-1.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/ibatis-2.3.4.726-patched.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jbpm/bsh-1.3.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jbpm/jbpm-identity-3.3.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jbpm/jbpm-jpdl-3.3.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jbpm/springmodules-jbpm31.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jgroups/jgroups-2.8.0-b2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jibx/jibx-bind.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jibx/jibx-run.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jmagick/JMagick.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/openoffice/jut.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/openoffice/openoffice-juh-2.0.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/openoffice/openoffice-jurt-2.0.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/openoffice/openoffice-ridl-2.0.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/openoffice/openoffice-sandbox-2.0.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/openoffice/openoffice-unoil-2.0.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/openoffice/xstream-1.2.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/xalan/serializer.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/xalan/xalan.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/activation.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/acegi-security-0.8.2_patched.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/addressing-1.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/antlr-2.7.5H3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/antlr-3.1.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/stringtemplate-3.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/aopalliance.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/axis-1.4.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/bcel.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/bcmail-jdk15-137.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/bcprov-jdk15-137.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/bliki-3.0.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/bsf-2.4.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/cglib-nodep-2.2_beta1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/chiba-1.3.0-patched.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/commons-modeler.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/cxf-2.2.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/dom4j-1.6.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/ehcache-1.4.1-patched.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/facebook_070716.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/FastInfoset-1.2.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/fontbox-0.8.0-incubating.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/freemarker-2.3.13.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/geronimo-activation_1.1_spec-1.0.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/geronimo-annotation_1.0_spec-1.1.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/geronimo-javamail_1.4_spec-1.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/geronimo-jaxws_2.1_spec-1.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/geronimo-stax-api_1.0_spec-1.0.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/geronimo-ws-metadata_2.0_spec-1.1.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/greenmail-1.3-patched.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/guessencoding-1.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/hibernate-3.2.6-patched.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/hrtlib.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/htmlparser-1.6.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/icu4j-2.3.0.677.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jakarta-oro-2.0.8.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jaxb-api-2.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jaxb-impl-2.1.7.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jaxb-xjc-2.1.7.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jaxen-1.1-beta-8.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jaxrpc.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jaxws-api-2.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jcr-1.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jid3lib-0.5.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/joda-time-1.2.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jooconverter-2.1.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/json.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jsr107cache-1.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jta.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jug-lgpl-2.0.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/optional/log4j-1.2.15.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/jutf7-1.0.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/lucene-analyzers-2.4.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/lucene-core-2.4.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/lucene-snowball-2.4.1.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/mail.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/myfaces-api-1.1.5.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/myfaces-impl-1.1.5.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/virtual-tomcat/naming-factory.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/virtual-tomcat/naming-resources.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/neethi-2.0.4.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/odf_utils.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/odmg-3.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/pdfbox-0.8.0-incubating.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/PDFRenderer.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/poi-3.5-FINAL-20090928.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/portlet-api-lib.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/quartz-1.6.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/resolver.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/rhino-js-1.6R7.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/saaj-api-1.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/saaj-impl-1.3.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/saaj.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/saxpath.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/shale-test-1.0.4.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/slf4j-api-1.5.8.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/slf4j-jcl-1.5.8.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.core-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.beans-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.expression-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.context-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.context.support-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.transaction-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.aop-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.asm-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.jdbc-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.orm-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.web-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/org.springframework.webmvc-${file.version.springframework}.jar"/>
         <pathelement location="${dir.project.3rdparty.lib}/standard.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/stax-utils-20060502.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/subetha-smtp.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/tm-extractors-1.0-patched.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/truezip.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/wsdl4j-1.6.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/wss4j.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/wstx-asl-3.2.4.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/xercesImpl-2.8.0.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/xml-apis.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/xml-resolver-1.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/xmlrpc.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/XmlSchema-1.4.2.jar" />
         <pathelement location="${dir.project.3rdparty.lib}/xpp3-1.1.3_8.jar" />
      </path>
     <!-- Extension point for overriding -->
      <path id="classpath.unit.test.extension"/>

      <path id="classpath.javadoc">
         <path refid="classpath.compile"/>
      </path>
     <!-- Extension point for overriding -->
      <path id="classpath.javadoc.extension"/>

      <patternset id="files.tests.startup">
         <include name="**/RepositoryStartupTest.java" />
      </patternset>
      <patternset id="files.tests">
         <exclude name="**/Base*Test.java" />
         <exclude name="**/Abstract*Test.java" />
         <exclude name="**/*SystemTest.java" />
         <exclude name="**/RepositoryStartupTest.java" />
         <!-- Action Tests -->
         <exclude name="**/org/alfresco/repo/action/**/*Test.java" />
         <include name="**/org/alfresco/repo/action/ActionTestSuite.java" />
         <!-- Content Tests -->
         <exclude name="**/org/alfresco/repo/content/**/*Test.java" />
         <include name="**/org/alfresco/repo/content/ContentTestSuite.java" />
         <include name="**/org/alfresco/repo/content/metadata/xml/XmlMetadataExtracterTest.java" />
         <!-- Domain Tests -->
         <exclude name="**/org/alfresco/repo/domain/**/*Test.java" />
         <include name="**/org/alfresco/repo/domain/DomainTestSuite.java" />
         <!-- Multilingual Tests -->
         <exclude name="**/org/alfresco/repo/model/ml/**/*Test.java" />
         <include name="**/org/alfresco/repo/model/ml/MultilingualTestSuite.java" />
         <!-- FileFolder Tests -->
         <exclude name="**/org/alfresco/repo/model/filefolder/**/*Test.java" />
         <include name="**/org/alfresco/repo/model/filefolder/FileFolderTestSuite.java" />
         <!-- Version Tests -->
         <exclude name="**/org/alfresco/repo/version/**/*Test.java" />
         <include name="**/org/alfresco/repo/version/VersionTestSuite.java" />
         <!-- AVM Tests -->
         <exclude name="**/org/alfresco/repo/avm/**/*Test.java" />
         <include name="**/org/alfresco/repo/avm/AVMTestSuite.java" />
         <!-- WCM Tests -->
         <exclude name="**/org/alfresco/wcm/**/*Test.java" />
         <include name="**/org/alfresco/wcm/WCMTestSuite.java" />
         <!-- All other tests -->
         <include name="**/*Test.java" />
         <!-- include the updated indexer tests -->
         <include name="**/LuceneCategoryTest2.java" />
<!--
         <include name="**/LuceneTest2.java" />
-->
      </patternset>
   </target>



   <!-- ****************************************************** -->
   <!-- ***************** Entry point targets **************** -->
   <!-- ****************************************************** -->

   <target name="build" 
           description="Performs a clean build of all projects" 
           depends="clean, incremental" />

   <target name="incremental-webclient-depends" 
           description="Performs an incremental build of the dependencies of the Alfresco WAR"
           depends="incremental-core,
                    incremental-jlan,
                    incremental-mbeans,
                    incremental-deployment,
                    incremental-repository,
                    incremental-wdrdeployment,
                    incremental-remoteapi,
                    incremental-webframeworkcommons,
                    incremental-jndi,
                    incremental-catalinavirtual, 
                    incremental-linkvalidation" />
   
   <target name="incremental" 
           description="Performs an incremental build of all projects"
           depends="incremental-webclient-depends,
                    incremental-webclient,  
                    incremental-webserviceclient,
                    incremental-slingshot,
                    incremental-mobile" />

   <target name="build-modules"
           description="Performs a clean build of all modules"
           depends="clean-modules, incremental-modules" />
   
   <target name="incremental-modules"
           description="Performs an incremental build of all modules"
           depends="incremental,
                    package-avmcompare-extension,
                    package-blog-extension,
                    package-fb-doclib-extension,
                    package-php-extension,
                    package-rm-extension, 
                    package-truncatemalformedxml-extension" />
                    <!-- package-mediawiki-extension, -->

   <target name="distribute-amps" 
           description="Creates the distribution AMP file for all extensions"
           depends="package-php-extension,
                    package-mediawiki-extension,
                    package-fb-doclib-extension,
   	                package-googlegadgets,
                    package-truncatemalformedxml-extension,
   	                package-sharepoint-extension,
                    package-dod5015-extension,
   	                package-dod5015-share-extension" >       
   	                <!-- package-rm-extension, -->
      <copy todir="${dir.continuous.dist}">
         <fileset dir="${dir.module.php.dist}"                  includes="${file.name.amp.php}" />
         <fileset dir="${dir.module.mediawiki.dist}"            includes="${file.name.amp.mediawiki}" />
<!--         <fileset dir="${dir.module.rm.dist}"                   includes="${file.name.amp.rm}" /> -->
         <fileset dir="${dir.module.truncatemalformedxml.dist}" includes="${file.name.amp.truncatemalformedxml}" />
         <fileset dir="${dir.module.fb.doclib.dist}"            includes="${file.name.amp.fb.doclib}" />
         <fileset dir="${dir.module.gg.dist}"                   includes="${file.name.zip.gg}" />
         <fileset dir="${dir.module.sharepoint.dist}"           includes="${file.name.amp.sharepoint}" />
         <fileset dir="${dir.module.dod5015.dist}"              includes="${file.name.amp.dod5015}" />
         <fileset dir="${dir.module.dod5015.share.dist}"        includes="${file.name.amp.dod5015.share}" />
      </copy>
   </target>

   <target name="build-tomcat" 
           description="Performs a clean build for Tomcat and deploys the Alfresco and application WAR files"
           depends="clean, incremental-tomcat" />

   <target name="incremental-tomcat" 
           description="Performs an incremental build for Tomcat and deploys the Alfresco and application WAR files"
           depends="incremental-webclient-tomcat, incremental-slingshot-tomcat" />
   
   <target name="incremental-webclient-tomcat" 
           description="Performs an incremental build and deployment of the Alfresco WAR"
           depends="incremental-webclient-depends,
                    incremental-webclient,
                    deploy-webclient-tomcat" />

   <target name="incremental-webclient-tomcat-exploded" 
           depends="incremental-webclient-depends,
                    package-webclient-jar,
                    deploy-webclient-tomcat-exploded" />
   
   <target name="incremental-mobile-tomcat" 
           description="Performs an incremental build and deployment of the mobile WAR"
           depends="incremental-core, 
                    incremental-mobile,
                    deploy-mobile-tomcat" />
   
  <target name="incremental-mobile-tomcat-exploded" 
          depends="incremental-core, 
                   package-mobile-jar,
                   deploy-mobile-tomcat-exploded,
                   minimize-mobile-deployed-javascript" />

   <target name="incremental-slingshot-tomcat"
           description="Performs an incremental build and deployment of the slingshot WAR"
           depends="package-webframeworkcommons-jar,
                    incremental-slingshot,
                    deploy-slingshot-tomcat" />

   <target name="incremental-slingshot-tomcat-exploded"
           depends="package-webframeworkcommons-jar,
                    package-slingshot-jar,
                    deploy-slingshot-tomcat-exploded,
                    minimize-slingshot-deployed-javascript" />

   <target name="generate-docs" 
           description="Compiles all documentation for all projects"
           depends="generate-javadocs-core, 
                    generate-javadocs-mbeans,
                    generate-javadocs-deployment,
                    generate-javadocs-repository, 
                    generate-javadocs-wdrdeployment,
                    generate-javadocs-remoteapi, 
                    generate-javadocs-jndi,
                    generate-javadocs-catalinavirtual, 
                    generate-javadocs-linkvalidation,
                    generate-javadocs-webclient, 
                    generate-taglibdocs-webclient, 
                    generate-javadocs-webserviceclient,
                    generate-javadocs-jlan,
                    generate-javadocs-mobile,
                    generate-javadocs-slingshot" />

   <!-- ****************************************************** -->
   <!-- ****************** Cleaning targets ****************** -->
   <!-- ****************************************************** -->

   <target name="clean" 
           description="Cleans everything, all projects, modules and all tomcat deployments"
           depends="clean-projects, clean-modules, clean-tomcat-deployments" />
      
   <target name="clean-projects" 
           description="Cleans all projects" 
           depends="clean-webclient-projects,
                    clean-slingshot-projects,
                    clean-mobile-projects,
                    clean-webserviceclient" />
                    
   <target name="clean-webclient-projects" 
           description="Cleans all projects related to the webclient project" 
           depends="clean-core,
                    clean-jlan, 
                    clean-mbeans,
                    clean-deployment, 
                    clean-repository, 
                    clean-wdrdeployment,
                    clean-remoteapi, 
                    clean-jndi, 
                    clean-catalinavirtual, 
                    clean-linkvalidation,
                    clean-webframeworkcommons,
                    clean-webclient" />
                    
   <target name="clean-slingshot-projects" 
           description="Cleans all projects related to the slingshot project" 
           depends="clean-webframeworkcommons,
                    clean-slingshot" />
                    
   <target name="clean-mobile-projects" 
           description="Cleans all projects related to the mobile project" 
           depends="clean-core,
                    clean-mobile" />
   
   <target name="clean-modules"
           description="Cleans all modules"
           depends="clean-avmcompare,
                    clean-blog,
                    clean-fb-doclib,
                    clean-mediawiki,
                    clean-php,
                    clean-rm, 
                    clean-sharepoint,
                    clean-truncatemalformedxml,
                    clean-dod5015,
                    clean-dod5015-share" />
   
   <target name ="clean-tomcat-deployments" 
           description="Cleans all Tomcat server deployments"
           depends="clean-webclient-tomcat-deploy,
                    clean-application-tomcat-deploy,
                    clean-virtual-tomcat-deploy" />
   
   <target name="clean-webclient-tomcat-deploy" 
           description="Cleans the Alfresco WAR from the Tomcat server" 
           depends="init">
      <delete file="${dir.deploy.tomcat}/${file.name.war.webclient}" />
      <delete dir="${dir.deploy.tomcat.webclient}" 
              includeEmptyDirs="true" 
              quiet="yes" />
   </target>
   
   <target name="clean-application-tomcat-deploy" 
           description="Cleans all apps from the application Tomcat server" 
           depends="init">
      <delete file="${dir.deploy.tomcat.application}/${file.name.war.slingshot}" />
      <delete dir="${dir.deploy.tomcat.application.slingshot}" 
              includeEmptyDirs="true" quiet="yes" />
      <delete file="${dir.deploy.tomcat.application}/${file.name.war.mobile}" />
      <delete dir="${dir.deploy.tomcat.application.mobile}" 
              includeEmptyDirs="true" quiet="yes" />
   </target>

   <target name="clean-virtual-tomcat-deploy"
           description="Cleans the Virtual Tomcat deployment" 
           depends="init">
       <delete failonerror="no">
           <!-- Remove old spring jar files lingering in common/lib, if any -->
           <fileset dir="${home.tomcat.virtual}/common/lib" includes="spring*.jar,org.springframework*.jar"/>

           <!-- Get rid of old config files -->
           <fileset dir="${home.tomcat.virtual}/conf" includes="alfresco-*"/>
       </delete>
   </target>
   
   <!--
   <target name="clean-jboss-deploy" 
           description="Cleans the Alfresco application from JBoss" 
           depends="init">
      <delete file="${dir.deploy.jboss}/${file.name.war.webclient}" />
   </target>
   -->

   <!-- ****************************************************** -->
   <!-- **************** Deployment targets ****************** -->
   <!-- ****************************************************** -->
   
   <target name="deploy-virtual-tomcat" 
           description="Deploys to Virtual Tomcat (the virtualization server)" 
           depends="init, clean-virtual-tomcat-deploy">
      <deploy-virtual-tomcat location="${home.tomcat.virtual}" />
   </target>
   
   <target name="-deploy-tomcat-common" depends="init">

      <available file="${home.tomcat}/common/lib" type="dir" property="tomcat5.present" />
      
      <fail if="tomcat5.present" message="Deployment using these scripts requires Tomcat 6." />

      <!-- ensure mysql drivers and xalan files are present -->
      <delete>
         <fileset dir="${home.tomcat}/lib" 
                  includes="mysql-connector*" 
                  excludes="${file.name.jar.mysql.connector}" />
      </delete>

      <copy todir="${home.tomcat}/lib"      
            file="${dir.project.3rdparty.lib}/${dir.name.devenv}/${file.name.jar.mysql.connector}" />

      <copy todir="${home.tomcat}/endorsed" 
            file="${dir.project.3rdparty.lib}/${dir.name.xalan}/${file.name.jar.xalan}" />

      <copy todir="${home.tomcat}/endorsed" 
            file="${dir.project.3rdparty.lib}/${dir.name.xalan}/${file.name.jar.serializer}" />

      <!-- copy the hotspot_compiler file to bin directory -->
      <copy todir="${home.tomcat}/bin" 
            file="${file.hotspotcompiler}" />

      <!-- enable WCM functionality -->
      <copy todir="${home.tomcat}/shared/classes/alfresco/extension" 
            file="${dir.project.installer}/wcm-bootstrap-context.xml" />
   </target>
   
   <target name="deploy-webclient-tomcat" 
           description="Deploys the Alfresco WAR to Tomcat" 
           depends="clean-webclient-tomcat-deploy, -deploy-tomcat-common, deploy-virtual-tomcat">
      <delete file="${dir.deploy.tomcat}/${file.name.war.webclient}" />
      <delete dir="${dir.deploy.tomcat.webclient}" 
              includeEmptyDirs="true" quiet="yes" />
      
      <!-- copy the alfresco WAR file to Tomcat's deploy folder -->
      <copy todir="${dir.deploy.tomcat}" 
            file="${dir.project.webclient.dist}/${file.name.war.webclient}" />
   </target>

   <target name="deploy-webclient-tomcat-exploded" 
           depends="-deploy-tomcat-common">
      
      <!-- remove the WAR, if necessary -->
      <delete file="${dir.deploy.tomcat}/${file.name.war.webclient}" />
      
      <!-- copy the class files from each project to the WEB-INF/classes folder -->
      <copy todir="${dir.deploy.tomcat.webclient}/WEB-INF/classes" verbose="${copy.verbose}">
      
         <!-- copy class files -->
         <fileset dir="${dir.project.core.classes}" />
         <fileset dir="${dir.project.mbeans.classes}" />
         <fileset dir="${dir.project.deployment.classes}" />
         <fileset dir="${dir.project.repository.classes}" 
                  excludes="**/extension/**" />
         <fileset dir="${dir.project.wdrdeployment.classes}" />
         <fileset dir="${dir.project.remoteapi.classes}" />
         <fileset dir="${dir.project.catalinavirtual.classes}" />
         <fileset dir="${dir.project.linkvalidation.classes}" />
         <fileset dir="${dir.project.webframeworkcommons.classes}" />
         <fileset dir="${dir.project.webclient.classes}" 
                  excludes="**/extension/**" />
         <fileset dir="${dir.project.jlan.classes}" excludes="org/alfresco/config/**" />
         
         <!-- copy config files -->
         <fileset dir="${dir.project.core.src.java}" 
                  includes="log4j.properties" />
         <fileset dir="${dir.project.repository.config}" 
                  excludes="**/extension/**" />
         <fileset dir="${dir.project.linkvalidation.config}" 
                  excludes="**/extension/**" />
         <fileset dir="${dir.project.remoteapi.config}"
                  excludes="**/extension/**" />
         <fileset dir="${dir.project.webclient.config}" 
                  excludes="**/extension/**" />
         <!-- NOTE: include dev-context.xml to allow developer overrides -->
         <fileset dir="${dir.project.repository.config}" 
                  includes="**/extension/dev-context.xml"/>
      </copy>

      <!-- 
           Temporary measure to help Eclipse users deal with 
           link validation dependencies.  This should be cleaned
           up when the build is transformed into a single project.
      -->
      <copy file="${dir.project.linkvalidation.config}/alfresco/alfresco-link-validation-bootstrap-context.xml"
            todir="${dir.deploy.tomcat.webclient}/WEB-INF/classes/alfresco/extension"/>

      <!-- explicitly copy the bootstrap file for remote api to get round dependency issue. -->
      <copy file="${dir.project.remoteapi.config}/alfresco/extension/bootstrap/remote-api-context.xml"
            todir="${dir.deploy.tomcat.webclient}/WEB-INF/classes/alfresco/extension/bootstrap"/>

      <!-- copy webclient web source files i.e. JSPs, images etc. -->
      <copy todir="${dir.deploy.tomcat.webclient}" verbose="${copy.verbose}">
         <fileset dir="${dir.project.webclient.src.web}" 
                  excludes="WEB-INF/jboss*.xml, WEB-INF/portlet*.xml, 
                            WEB-INF/alfresco-object.xml" />
      </copy>
      
      <!-- copy required 3rd party libs -->
      <copy todir="${dir.deploy.tomcat.webclient}/WEB-INF/lib" verbose="${copy.verbose}">
         <fileset dir="${dir.project.3rdparty.lib}" includes="*.jar" 
                  excludes="${dir.name.devenv}/**" />
         <fileset dir="${dir.project.3rdparty.lib}/optional" includes="*.jar" /> 
         <fileset dir="${dir.project.3rdparty.lib}/jibx" includes="*.jar" />
         <fileset dir="${dir.project.3rdparty.lib}/openoffice" includes="*.jar" />
         <fileset dir="${dir.project.3rdparty.lib}/jmagick" includes="*.jar" />
         <fileset dir="${dir.project.3rdparty.lib}/commons" includes="*.jar" />
         <fileset dir="${dir.project.3rdparty.lib}/spring-surf" includes="*.jar" />
         <fileset dir="${dir.project.3rdparty.lib}/jgroups" includes="*.jar" />
         <fileset dir="${dir.project.3rdparty.lib}/jbpm" includes="*.jar" />
         <fileset dir="${dir.project.3rdparty.lib}/fop" includes="*.jar"/>
         <fileset dir="${dir.project.3rdparty.lib}/abdera" includes="*.jar"/>
      </copy>
      
      <!-- copy webservices files -->
      <copy todir="${dir.deploy.tomcat.webclient}/WEB-INF" verbose="${copy.verbose}">
         <fileset dir="${dir.project.remoteapi.src.webinf}"/>
      </copy>
      <copy todir="${dir.deploy.tomcat.webclient}/wsdl" verbose="${copy.verbose}">
         <fileset dir="${dir.project.remoteapi.src.wsdl}" />
      </copy>
      <copy todir="${dir.deploy.tomcat.webclient}/WEB-INF/classes/META-INF" verbose="${copy.verbose}">
         <fileset dir="${dir.project.remoteapi.src.metainf}"/>
      </copy>
   </target>
   
   <target name="deploy-webclient-changes" depends="init">
      <copy todir="${dir.deploy.tomcat.webclient}" verbose="${copy.verbose}">
         <fileset dir="${dir.project.webclient.src.web}" excludes="WEB-INF/**" />
      </copy>
   </target>
   
   <target name="deploy-slingshot-tomcat" depends="init" 
           description="Deploys the slingshot WAR to the application Tomcat server">
      <delete file="${dir.deploy.tomcat.application}/${file.name.war.slingshot}" />
      <delete dir="${dir.deploy.tomcat.application.slingshot}" 
              includeEmptyDirs="true" quiet="yes" />
      
      <!-- copy the slingshot WAR file to the application Tomcat deploy folder -->
      <copy todir="${dir.deploy.tomcat.application}" 
            file="${dir.project.slingshot.dist}/${file.name.war.slingshot}" />
   </target>
   
   <target name="deploy-slingshot-tomcat-exploded" depends="init">
      <!-- remove the WAR, if necessary -->
      <delete file="${dir.deploy.tomcat.application}/${file.name.war.slingshot}" />
      
      <!-- copy all source files, ensuring slingshot project files are copied first -->
      <copy todir="${dir.deploy.tomcat.application.slingshot}" verbose="${copy.verbose}">
         <fileset dir="${dir.project.slingshot.src.web}" />
      </copy>
      <copy todir="${dir.deploy.tomcat.application.slingshot}" verbose="${copy.verbose}">
         <fileset dir="${dir.project.webframeworkcommons.src.web}" excludes="WEB-INF/web.xml" />
      </copy>
      
      <!-- copy config files, ensuring slingshot project files are copied first -->
      <copy todir="${dir.deploy.tomcat.application.slingshot}/WEB-INF/classes" verbose="${copy.verbose}">
         <fileset dir="${dir.project.slingshot.config}" excludes="**/extension/**" />
      </copy>
      <copy todir="${dir.deploy.tomcat.application.slingshot}/WEB-INF/classes" verbose="${copy.verbose}">
         <fileset dir="${dir.project.webframeworkcommons.config}" excludes="**/extension/**" />
      </copy>
      
      <!-- add all class files to WEB-INF/classes, ensuring slingshot project files are copied first -->
      <copy todir="${dir.deploy.tomcat.application.slingshot}/WEB-INF/classes" verbose="${copy.verbose}">
         <fileset dir="${dir.project.slingshot.classes}" />
      </copy>
      <copy todir="${dir.deploy.tomcat.application.slingshot}/WEB-INF/classes" verbose="${copy.verbose}">
         <fileset dir="${dir.project.jlan.classes}" />
         <fileset dir="${dir.project.webframeworkcommons.classes}" />
      </copy>
      
      <!-- add all JARs to WEB-INF/lib -->
      <copy todir="${dir.deploy.tomcat.application.slingshot}/WEB-INF/lib" verbose="${copy.verbose}">
         <fileset dir="${dir.project.3rdparty.lib}" 
                  includes="${includes.webscriptframework.libs}" />
         <fileset dir="${dir.project.3rdparty.lib}/optional" 
                 includes="${includes.webscriptframework.libs.optional}" />
         <fileset dir="${dir.project.3rdparty.lib}/commons" 
                  includes="${includes.webscriptframework.libs.commons}" />
         <fileset dir="${dir.project.3rdparty.lib}/spring-surf" 
                  includes="${includes.webscriptframework.libs.spring-surf}" />
         <fileset dir="${dir.project.3rdparty.lib}/abdera"  
                  includes="${includes.webscriptframework.libs.abdera}" />
      </copy>

      <!-- unzip and add 3rd party javascript library -->
      <unzip src="${file.zip.slingshot.yui}"
             dest="${dir.deploy.tomcat.application.slingshot}" />
             
      <!-- there seems to be a hidden __MACOSX folder in the YUI -->
      <!-- distribution, remove it if present -->
      <delete dir="${dir.deploy.tomcat.application.slingshot}/__MACOSX" 
              includeEmptyDirs="true" quiet="yes" />

      <!-- Copy our yui directory to apply YUI fixes -->
      <copy todir="${dir.deploy.tomcat.application.slingshot}/yui" verbose="${copy.verbose}">
         <fileset dir="${dir.project.slingshot.src.web}/yui" />
      </copy>

   </target>

   <target name="minimize-slingshot-deployed-javascript" depends="init">
      <apply executable="java" parallel="false" dest="${dir.deploy.tomcat.application.slingshot}">
         <fileset dir="${dir.deploy.tomcat.application.slingshot}">
            <include name="**/*.js" />
            <exclude name="**/*-min.js" />
            <exclude name="**/WEB-INF/**" />
            <exclude name="**/tiny_mce/**" />
            <exclude name="**/yui/**" />
         </fileset>
         <arg line="-jar"/>
         <arg path="${dir.project.slingshot}/lib/yuicompressor-2.4.2.jar"/>
         <arg line="-o"/>
         <targetfile />
         <srcfile />
         <mapper type="glob" from="*.js" to="*-min.js"/>
      </apply>
   </target>
   
   <target name="deploy-mobile-tomcat" depends="init" 
           description="Deploys the mobile WAR to the application Tomcat server">
      <delete file="${dir.deploy.tomcat.application}/${file.name.war.mobile}" />
      <delete dir="${dir.deploy.tomcat.application.mobile}" 
              includeEmptyDirs="true" quiet="yes" />
      
      <!-- copy the mobile WAR file to the application Tomcat deploy folder -->
      <copy todir="${dir.deploy.tomcat.application}" 
            file="${dir.project.mobile.dist}/${file.name.war.mobile}" />
   </target>

   <target name="deploy-mobile-tomcat-exploded" depends="init">
      <!-- remove the WAR, if necessary -->
      <delete file="${dir.deploy.tomcat.application}/${file.name.war.mobile}" />
      
      <!-- copy all source files -->
      <copy todir="${dir.deploy.tomcat.application.mobile}" verbose="${copy.verbose}">
         <fileset dir="${dir.project.mobile.src.web}" />
      </copy>
      
      <!-- copy config files -->
      <copy todir="${dir.deploy.tomcat.application.mobile}/WEB-INF/classes" verbose="${copy.verbose}">
         <fileset dir="${dir.project.core.src.java}" includes="log4j.properties" />
         <fileset dir="${dir.project.mobile.config}" excludes="**/extension/**" />
      </copy>
      
      <!-- add all class files to WEB-INF/classes -->
      <copy todir="${dir.deploy.tomcat.application.mobile}/WEB-INF/classes" verbose="${copy.verbose}">
         <fileset dir="${dir.project.core.classes}" />
         <fileset dir="${dir.project.mobile.classes}" />
      </copy>
      
      <!-- add all JARs to WEB-INF/lib -->
      <copy todir="${dir.deploy.tomcat.application.mobile}/WEB-INF/lib" verbose="${copy.verbose}">
         <fileset dir="${dir.project.3rdparty.lib}" 
                  includes="${includes.webscriptframework.libs}" />
         <fileset dir="${dir.project.3rdparty.lib}/optional" 
                 includes="${includes.webscriptframework.libs.optional}" />
         <fileset dir="${dir.project.3rdparty.lib}/commons" 
                  includes="${includes.webscriptframework.libs.commons}" />
         <fileset dir="${dir.project.3rdparty.lib}/spring-surf" 
                  includes="${includes.webscriptframework.libs.spring-surf}" />
         <fileset dir="${dir.project.3rdparty.lib}/abdera"  
                  includes="${includes.webscriptframework.libs.abdera}" />
      </copy>
   </target>

   <target name="minimize-mobile-deployed-javascript" depends="init">
      <concat destfile="${dir.deploy.tomcat.application.mobile}/js/alf-mobile.js">
         <fileset dir="${dir.deploy.tomcat.application.mobile}">
            <include name="**/*.js" />
            <exclude name="**/alf-mobile.js" />
            <exclude name="**/*-min.js" />
            <exclude name="**/WEB-INF/**" />
         </fileset>
      </concat>

      <apply executable="java" parallel="false" dest="${dir.deploy.tomcat.application.mobile}/js">
         <fileset dir="${dir.deploy.tomcat.application.mobile}/js" includes="alf-mobile.js"/>
         <arg line="-jar"/>
         <arg path="${dir.project.mobile}/lib/yuicompressor-2.4.2.jar"/>
         <arg line="-o"/>
         <targetfile/>
         <srcfile/>
         <mapper type="glob" from="*.js" to="*-min.js"/>
      </apply>
   </target>

   <target name="start-tomcat-webclient" 
           description="Starts the Alfresco Tomcat server on Windows" 
           depends="init">
      <exec dir="${home.tomcat}/bin" 
            executable="cmd.exe" 
            spawn="true">
         <arg line="/k startup.bat" />
      </exec>
   </target>

   <target name="start-tomcat-virtual" 
           description="Starts the virtual Tomcat server on Windows" 
           depends="init">
      <exec dir="${home.tomcat.virtual}/bin" 
            executable="cmd.exe" 
            spawn="true">
         <arg line="/k startup.bat" />
      </exec>
   </target>

   <target name="start-tomcat-application" 
           description="Starts the application Tomcat server on Windows" 
           depends="init">
      <exec dir="${home.tomcat.application}/bin" 
            executable="cmd.exe" 
            spawn="true">
         <arg line="/k startup.bat" />
      </exec>
   </target>

   <target name="start-tomcat-webclient-debug"
           description="Starts the Alfresco Tomcat server on Windows in debug mode" 
           depends="init">
      <fail unless="env.JPDA_ADDRESS" 
            message="To run Tomcat in debug mode you need to setup the JPDA_ADDRESS enviornment variable"/>
      <fail unless="env.JPDA_TRANSPORT"
            message="To run Tomcat in debug mode you need to setup the JPDA_TRANSPORT enviornment variable"/>
      
      <exec dir="${home.tomcat}/bin" 
            executable="cmd.exe" 
            spawn="true">
         <arg line="/k catalina.bat jpda start" />
      </exec>
   </target>
   
   <!--
   <target name="deploy-jboss" 
           description="Deploys to JBoss" 
           depends="clean-jboss-deploy">
      <copy todir="${dir.deploy.jboss}" 
            file="${dir.project.webclient.dist}/${file.name.war.webclient}" />
      <delete>
         <fileset dir="${home.jboss}/server/default/lib" 
                  includes="mysql-connector*" 
                  excludes="${file.name.jar.mysql.connector}" />
      </delete>

      <copy todir="${home.jboss}/server/default/lib" 
            file="${dir.project.3rdparty.lib}/${dir.name.devenv}/${file.name.jar.mysql.connector}" />

      <copy todir="${home.jboss}/bin" 
            file="${file.hotspotcompiler}" />
   </target>
   
   <target name="start-jboss" 
           description="Starts the JBoss server on Windows" 
           depends="init">
      <exec dir="${home.jboss}/bin" 
            executable="cmd.exe" 
            spawn="true">
         <arg line="/k start run.bat" />
      </exec>
   </target>
   -->

   <target name="deploy-amp" 
           description="Deploys an AMP file to the web client WAR file. Usage deploy-amp -Dampfile=[ampfile]" 
           depends="init">
      <fail unless="ampfile" 
            message="You must supply the path to an AMP file using -Dampfile=[ampfile]"/>
      <install-amp ampfile="${ampfile}" 
                   warfile="${dir.project.webclient.dist}/${file.name.war.webclient}" />
   </target>



   <!-- ****************************************************** -->
   <!-- ****************** Testing targets ******************* -->
   <!-- ****************************************************** -->

   <target name="test" 
           description="Runs unit tests for all the projects" 
           depends="clean, 
                    incremental, 
                    test-core, 
                    test-mbeans,
                    test-deployment, 
                    test-repository, 
                    test-remoteapi,
                    test-wdrdeployment,
                    test-catalinavirtual,
                    test-webframeworkcommons, 
                    test-webclient, 
                    test-webserviceclient,
                    test-dod5015" />

   <target name="run-junit-test" 
           description="Runs a single JUnit test. Usage run-test -Dtestcase=[test] -Dprojectdir=[dir] [-Dstoponerror=[yes|no]]"
           depends="init">
      <fail unless="testcase" 
            message="You must supply a testcase to run using -Dtestcase=[test]"/>
      <fail unless="projectdir" 
            message="You must supply a projectdir to run using -Dprojectdir=[dir]"/>
      
      <condition property="haltonfailure" else="no">
         <and>
            <isset property="stoponerror" />
            <istrue value="${stoponerror}" />
         </and>
      </condition>

      <mkdir dir="${projectdir}/${dir.name.build}/${dir.name.test.results}" />

      <junit printsummary="yes" 
             fork="yes" 
             maxmemory="${mem.size.max}" 
             haltonfailure="${haltonfailure}" 
             dir="${projectdir}">
         <jvmarg value="-server"/>
         <jvmarg value="-XX:MaxPermSize=128M"/>
         <classpath refid="classpath.unit.test" />
         <formatter type="xml" />
         <test name="${testcase}" 
               todir="${projectdir}/${dir.name.build}/${dir.name.test.results}" />
      </junit>
   </target>

   <!-- Run a junit test without the irritatingly dumb junit task output in memory buffering -->
   <target name="run-test" 
           description="Runs a single JUnit test bypassing the junit task. Usage run-test -Dtestcase=[test] -Dprojectdir=[dir]"
           depends="init">
      <fail unless="testcase" 
            message="You must supply a testcase to run using -Dtestcase=[test]"/>
      <fail unless="projectdir" 
            message="You must supply a projectdir to run using -Dprojectdir=[dir]"/>

      <mkdir dir="${projectdir}/${dir.name.build}/${dir.name.test.results}" />
      <java fork="yes" 
            classname="junit.textui.TestRunner" 
            dir="${projectdir}"
            output="${projectdir}/${dir.name.build}/${dir.name.test.results}/${testcase}.out">
         <jvmarg value="-Xmx${mem.size.max}"/>
         <jvmarg value="-server"/>
         <arg value="${testcase}"/>
         <classpath refid="classpath.unit.test"/>
      </java>
   </target>

   <target name="run-forms-engine-tests" depends="init, test-webframeworkcommons">
      <!-- run FormService test -->
      <antcall target="run-junit-test">
         <param name="testcase" value="org.alfresco.repo.forms.FormServiceImplTest" />
         <param name="projectdir" value="${dir.project.repository}" />
         <param name="stoponerror" value="yes" />
      </antcall>
      
      <!-- run REST API tests -->
      <antcall target="run-junit-test">
         <param name="testcase" value="org.alfresco.repo.web.scripts.forms.FormRestApiGet_Test" />
         <param name="projectdir" value="${dir.project.remoteapi}" />
         <param name="stoponerror" value="yes" />
      </antcall>
      <antcall target="run-junit-test">
         <param name="testcase" value="org.alfresco.repo.web.scripts.forms.FormRestApiJsonPost_Test" />
         <param name="projectdir" value="${dir.project.remoteapi}" />
         <param name="stoponerror" value="yes" />
      </antcall>
   </target>

   <!-- ****************************************************** -->
   <!-- ******************** Debug targets ******************* -->
   <!-- ****************************************************** -->

   <target name="dump-properties" 
           depends="dump-version, 
                    dump-env-properties, 
                    dump-dir-properties, 
                    dump-file-properties" />

   <target name="dump-version" 
           depends="init">
      <echo level="info">version.number = ${version.number}</echo>
   </target>

   <target name="dump-env-properties" 
           depends="init">
      <echo level="info">alfresco.basedir = ${alfresco.basedir}</echo>
      <echo level="info">dir.projects = ${dir.projects}</echo>
      <echo level="info">user.home = ${user.home}</echo>
      <echo level="info">ant.home = ${ant.home}</echo>
      <echo level="info">home.tomcat = ${home.tomcat}</echo>
      <echo level="info">home.tomcat.application = ${home.tomcat.application}</echo>
      <echo level="info">home.tomcat.virtual = ${home.tomcat.virtual}</echo>
      <echo level="info">home.jboss = ${home.jboss}</echo>
      <echo level="info">home.findbugs = ${home.findbugs}</echo>
   </target>

   <target name="dump-dir-properties" 
           depends="init">
       <echoproperties prefix="dir" />
   </target>

   <target name="dump-file-properties" 
           depends="init">
      <echoproperties prefix="file" />
   </target>

   <target name="dump-arbitary-properties" 
           depends="init">
      <fail unless="prefix" 
            message="You must supply a prefix i.e. -Dprefix=file.name" />
      <echoproperties prefix="${prefix}" />
   </target>

   <target name="dump-all-properties" 
           depends="init">
      <echoproperties />
   </target>

   <target name="file-format-check" description="Find modified text files that are not WINDOWS, UTF-8.  Look in directory -Ddir=[dir]" depends="init" >
      <fail unless="dir" 
            message="You must supply a directory to run against using -Ddir=[dir]"/>
      <java fork="yes" 
            classname="org.alfresco.util.Convert" 
            dir="." >
         <classpath refid="classpath.unit.test" />
         <arg line="--dry-run --svn-status --encoding=UTF-8 --line-ending=WINDOWS --match=(.classpath|.java|.xml|.xsd|.jsp|.properties|.txt|.sql)$ --ignore=(.svn|classes) ${dir}"/>
      </java> 
   </target> 

   <target name="file-format-fix" description="Fix modified text files that are not WINDOWS, UTF-8.  Look in directory -Ddir=[dir]" depends="init" >
      <fail unless="dir" 
            message="You must supply a directory to run against using -Ddir=[dir]"/>
      <java fork="yes" 
            classname="org.alfresco.util.Convert" 
            dir="." >
         <classpath refid="classpath.unit.test" />
         <arg line="--no-backup --svn-status --encoding=UTF-8 --line-ending=WINDOWS --match=(.classpath|.java|.xml|.xsd|.jsp|.properties|.txt|.sql)$ --ignore=(.svn|classes) ${dir}"/>
      </java> 
   </target> 

   <!-- ****************************************************** -->
   <!-- ************** DOD5015 Exploded targets ************** -->
   <!-- ****************************************************** -->

   <target name="incremental-dod5015-repo-exploded"
           depends="init,
                    deploy-dod5015-repo-exploded">
   </target>

   <target name="deploy-dod5015-repo-exploded"
           depends="init,
                    package-dod5015-jar">
      <!-- copy jar -->
      <copy todir="${dir.deploy.tomcat.webclient}/WEB-INF/lib"
            file="${dir.module.dod5015.dist}/${file.name.jar.dod5015}" />
      <!-- copy web scripts, etc. -->
      <copy todir="${dir.deploy.tomcat.webclient}/WEB-INF/classes" verbose="${copy.verbose}" overwrite="yes">
         <fileset dir="${dir.module.dod5015.config}">
            <include name="**/*.*" />
         </fileset>
      </copy>
   </target>

   <target name="incremental-dod5015-share-exploded"
           depends="init,
                    deploy-dod5015-share-exploded,
                    minimize-slingshot-deployed-javascript">
   </target>
   
   <target name="deploy-dod5015-share-exploded"
           depends="init">
      <!-- copy all source files -->
      <copy todir="${dir.deploy.tomcat.application.slingshot}" verbose="${copy.verbose}" overwrite="yes">
         <fileset dir="${dir.modules}/dod-5015-share/source/web" />
      </copy>
      <!-- copy web scripts, etc. -->
      <copy todir="${dir.deploy.tomcat.application.slingshot}/WEB-INF/classes" verbose="${copy.verbose}" overwrite="yes">
         <fileset dir="${dir.modules}/dod-5015-share/config">
            <include name="**/*.*" />
         </fileset>
      </copy>
   </target>

   <!--- Stub target get overridden in other build scripts -->
   <target name="distribute-extras" description="Build distribution targets for enterprise projects" />


</project>
