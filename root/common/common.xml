<project name="common">

    <!-- ****************************************** -->
    <!-- ** Initialisation/Configuration targets ** -->
    <!-- ****************************************** -->

    <property name="dir.common" value="${basedir}" />
    <import file="${dir.common}/common-init.xml" />

    <!-- *********************** -->
    <!-- ** Composite targets ** -->
    <!-- *********************** -->

    <target name="build" depends="clean, package" description="Builds the project after cleaning" />

    <target name="incremental" depends="package" description="Incrementally builds the project" />

    <!-- ************************* -->
    <!-- ** Compilation targets ** -->
    <!-- ************************* -->

    <target name="compile-java" depends="init" description="Compiles the Java source code">
        <mkdir dir="${dir.classes}" />
        <javac destdir="${dir.classes}" memoryMaximumSize="1024m" fork="true" deprecation="on" debug="on" target="1.5" source="1.5">
            <src path="${dir.src.java}" />
            <classpath refid="classpath.compile" />
        </javac>

        <copy todir="${dir.classes}">
            <fileset dir="${dir.src.java}">
                <patternset>
                    <exclude name="**/*.java" />
                    <exclude name="log4j.properties" />
                </patternset>
            </fileset>
        </copy>
    </target>

    <target name="compile-javadocs" depends="init" description="Creates the JavaDocs for the project">
        <mkdir dir="${dir.javadoc}" />
        <javadoc maxmemory="1024m" 
                 sourcepath="${dir.src.java}" 
                 destdir="${dir.javadoc}" 
                 packagenames="${javadoc.packages.include}"
                 excludepackagenames="${javadoc.packages.exclude}" 
                 author="true" 
                 version="true" 
                 doctitle="${javadoc.title.document}"
                 windowtitle="${javadoc.title.window}" 
                 classpathref="classpath.compile" 
                 bottom="${javadoc.copyright}">

                <!-- doclet that hides public classes/members via @exclude -->
                <doclet name="ExcludeDoclet"
                        path="${dir.common.lib}/exclude-doclet.jar"/>
        </javadoc>
    </target>

    <target name="compile-taglibdocs" depends="init" description="Creates the tag library docs for the project">
        <mkdir dir="${dir.taglibdoc}" />
        <java fork="true" jar="${dir.common.lib}/tlddoc.jar" failonerror="true">
            <arg line="-d ${dir.taglibdoc}" />
            <arg line="-doctitle '${taglibdoc.title.document}'" />
            <arg line="-windowtitle '${taglibdoc.title.window}'" />
            <arg value="${dir.src.webinf}/*.tld" />
        </java>
    </target>

    <target name="run-tests" depends="package-jar" description="Runs the projects unit tests">
        <mkdir dir="${dir.test.results}" />
        <junit printsummary="yes" fork="yes" maxmemory="512M" haltonfailure="no" dir="${basedir}">
            <jvmarg value="-server"/>
            <classpath refid="classpath.unit.test" />
            <formatter type="xml" />
            <batchtest todir="${dir.test.results}">
                <fileset dir="${dir.src.java}">
                    <include name="**/*Test.java" />
                    <exclude name="**/Base*Test.java" />
                    <exclude name="**/Abstract*Test.java" />
                    <exclude name="**/*SystemTest.java" />
                    <!-- exclude tests which need special path fix up -->
                    <exclude name="**/AlfrescoDataLoaderComponentImplTest.java" />
                    <exclude name="**/CreationProfileTest.java" />
                </fileset>
            </batchtest>
        </junit>
    </target>

    <target name="run-test" depends="package-jar" description="Runs a single test defined in the testcase property i.e. call this target with -Dtestcase=[test]">
        <mkdir dir="${dir.test.results}" />
        <junit printsummary="yes" fork="yes" maxmemory="512M" haltonfailure="no" dir="${basedir}">
            <jvmarg value="-server"/>
            <classpath refid="classpath.unit.test" />
            <formatter type="plain" />
            <test name="${testcase}" todir="${dir.test.results}" />
        </junit>
    </target>

    <!-- Run a junit test without the irritatingly dumb junit task output in memory buffering -->
    <target name="run-junit" depends="package-jar" description="Runs a single unit test bypassing the junit task.">
        <java fork="yes" classname="junit.textui.TestRunner" output="${testcase}.out">
            <jvmarg value="-Xmx512m"/>
            <jvmarg value="-server"/>
            <arg value="${testcase}"/>
            <classpath refid="classpath.unit.test"/>
        </java>
    </target>

    <!-- *********************** -->
    <!-- ** Packaging targets ** -->
    <!-- *********************** -->

    <!-- we provide the package target so projects can override to build what they need -->
    <target name="package" depends="package-jar" description="Packages the archive files" />

    <target name="package-jar" depends="compile-java" description="Packages the JAR file">
        <mkdir dir="${dir.dist}" />
        <jar jarfile="${dir.dist}/${file.name.jar}" basedir="${dir.classes}" />
    </target>

    <target name="package-war" depends="assemble-war" description="Packages the WAR file">
        <mkdir dir="${dir.dist}" />
        <war warfile="${dir.dist}/${file.name.war}" webxml="${dir.src.webinf}/web.xml">
           <fileset dir="${dir.assemble}" />
        </war>
    </target>
   
    <target name="assemble-war" depends="package-jar">
       <mkdir dir="${dir.assemble}" />
       
       <copy todir="${dir.assemble}">
          <fileset dir="${dir.src.web}" excludes="WEB-INF/**" />
       </copy>
       
       <java classname="CommentStripper" dir="${dir.assemble}" fork="yes">
          <arg line="-l -t -r .jsp" />
          <classpath refid="classpath.compile" />
       </java>
       
       <copy todir="${dir.assemble}/WEB-INF">
          <fileset dir="${dir.src.webinf}" includes="${webinf.includes}" excludes="${webinf.excludes}" />
       </copy>
       
       <copy todir="${dir.assemble}/WEB-INF/lib">
          <fileset dir="${dir.common.lib}" includes="${webinf.lib.includes}" excludes="${webinf.lib.excludes}" />
          <fileset dir="${dir.dist}" includes="${file.name.jar}" />
       </copy>
    </target>

    <!-- ********************** -->
    <!-- ** Cleaning targets ** -->
    <!-- ********************** -->

    <target name="clean" depends="init" description="Cleans the project">
        <delete includeEmptyDirs="true" quiet="yes" dir="${dir.classes}" />
        <delete includeEmptyDirs="true" quiet="yes" dir="${dir.dist}" />
        <delete includeEmptyDirs="true" quiet="yes" dir="${dir.assemble}" />
        <delete includeEmptyDirs="true" quiet="yes" dir="${dir.test.results}" />
        <delete includeEmptyDirs="true" quiet="yes" dir="${dir.docs}" />
    </target>

</project>

