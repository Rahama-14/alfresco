<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="urn:jbpm.org:jpdl-3.1" name="wf:invite">

   <swimlane name="initiator">
      <assignment actor-id="#{wf_inviterUserName}"/>
   </swimlane>
   
   <swimlane name="assignee"/>
      <!-- <assignment actor-id="#{wf_inviteeUserName}"/> -->

   <start-state name="start">
      <task name="wf:inviteToSiteTask" swimlane="initiator" />
      <transition name="sendInvite" to="invitePending">
         <action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
            <script>
               // TODO glen johnson at alfresco dot com - get hold of the host 
               // and port for where the caller web script is located
               var hostname = "localhost";
               var port = 8080;
                           
               // get workflow instance ID
               var workflowId = executionContext.processInstance.id;
               
               // get the invitee person
               var inviteePerson = people.getPerson(wf_inviteeUserName);
                
               var mail = actions.create("mail");
               mail.parameters.to = inviteePerson.properties["cm:email"];
               mail.parameters.subject = "Invitation to Site " + wf_siteShortName;
               mail.parameters.from = initiator.properties["cm:email"];
               
               mail.parameters.text = "Hello,\n"
                  + "You have been invited to join the site: "
                  + wf_siteShortName + "\n"
                  + "Please click here "
                  + "http://" + hostname + ":" + port
                  + "/alfresco/service/api/inviteresponse/accept?"
                  + "workflowId=" + workflowId
                  + "&amp;inviteeUserName=" + wf_inviteeUserName
                  + "&amp;siteShortName=" + wf_siteShortName
                  + " to accept the invitation\n\n"
                  + "An account has been created for you with user name: "
                  + wf_inviteeUserName  + ".\n"
                  + "An initial password has been generated for you: "
                  + wf_inviteeGenPassword + ".\n"
                  + "Please change it to a password of your choice once you "
                  + "have logged into the site.\n\n"
                  + "To reject the invitation to join the site: "
                  + wf_siteShortName + ", "
                  + "please click here "
                  + "http://" + hostname + ":" + port
                  + "/alfresco/service/api/inviteresponse/reject?"
                  + "workflowId=" + workflowId
                  + "&amp;inviteeUserName=" + wf_inviteeUserName
                  + "&amp;siteShortName=" + wf_siteShortName;
                  
               mail.execute(bpm_package);
            </script>
         </action>
      </transition>
   </start-state>

   <task-node name="invitePending">
      <task name="wf:invitePendingTask" swimlane="assignee" />
      <transition name="accept" to="inviteAccepted" />
      <transition name="reject" to="inviteRejected" />
   </task-node>

   <task-node name="inviteAccepted">
      <task name="wf:acceptInviteTask" swimlane="assignee" />
      <transition name="" to="end" />
   </task-node>

   <task-node name="inviteRejected">
      <task name="wf:rejectInviteTask" swimlane="assignee" />
      <transition name="" to="end" />
   </task-node>

   <end-state name="end" />

</process-definition>
