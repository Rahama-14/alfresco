<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="urn:jbpm.org:jpdl-3.1" name="wf:invite">

   <swimlane name="initiator"/>
   
   <swimlane name="assignee"/>

   <start-state name="start">
      <task name="wf:inviteToSiteTask" swimlane="initiator" />
      <transition name="sendInvite" to="invitePending">
         <action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
            <script>
               var workflowId = executionContext.processInstance.id;
               var inviterPerson = people.getPerson(wf_inviterUserName);
               var inviteePerson = people.getPerson(wf_inviteeUserName);
               var mail = actions.create("mail");
               mail.parameters.to = inviteePerson.properties["cm:email"];
               mail.parameters.subject = "Invitation to Alfresco Share Site "
                  + "'" + wf_siteShortName +"'";
               mail.parameters.from = inviterPerson.properties["cm:email"];
               var mail_text_invitee_account_section = "";
               if (wf_inviteeGenPassword != null)
               {
                  mail_text_invitee_account_section = "An account has been "
                  + "created for you with user name: " + wf_inviteeUserName
                  + ".\n"
                  + "This account is initially disabled. However it will be "
                  + "enabled if you accept the invitation, but only after your "
                  + "response has been received and processed.\n\n"  
                  + "An initial password has been generated for you: "
                  + wf_inviteeGenPassword + ".\n"
                  + "You are strongly advised to change it to a password of "
                  + "your choice once you have logged into Alfresco Share.\n\n";
               }
               mail.parameters.text = "Dear " + wf_inviteeFirstName + ",\n\n"
                  + "You have been invited to join a site on Alfresco Share: "
                  + wf_siteShortName + "\n\n"
                  + "To accept the invitation to join the site "
                  + "'" + wf_siteShortName + "', "
                  + "please follow this link:\n"
                  + wf_serverPath
                  + "/alfresco/service/api/inviteresponse/accept?format=html"
                  + "&amp;inviteId=" + workflowId
                  + "&amp;inviteeUserName=" + wf_inviteeUserName
                  + "&amp;siteShortName=" + wf_siteShortName + "\n\n"
                  + mail_text_invitee_account_section
                  + "To reject the invitation to join the site "
                  + "'" + wf_siteShortName + "', "
                  + "please follow this link:\n"
                  + wf_serverPath
                  + "/alfresco/service/api/inviteresponse/reject?format=html"
                  + "&amp;inviteId=" + workflowId
                  + "&amp;inviteeUserName=" + wf_inviteeUserName
                  + "&amp;siteShortName=" + wf_siteShortName;
               mail.execute(bpm_package);
            </script>
         </action>
      </transition>
   </start-state>

   <task-node name="invitePending">
      <task name="wf:invitePendingTask" swimlane="assignee" />
      <transition name="accept" to="inviteAccepted" />
      <transition name="reject" to="inviteRejected" />
   </task-node>

   <task-node name="inviteAccepted">
      <task name="wf:acceptInviteTask" swimlane="assignee" />
      <!-- TODO glen.johnson - code in acceptInvite(...) method of inviteresponse web script -->
      <!-- needs to be moved into action for transition "end" below.                         -->
      <transition name="end" to="end" />
   </task-node>

   <task-node name="inviteRejected">
      <task name="wf:rejectInviteTask" swimlane="assignee" />
      <!-- TODO glen.johnson - code in rejectInvite(...) method of inviteresponse web script -->
      <!-- needs to be moved into action for transition "end" below.                         -->
      <transition name="end" to="end" />
   </task-node>

   <end-state name="end" />

</process-definition>
