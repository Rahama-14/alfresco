<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING/DTD BEAN//EN"
	"http://www.springframework.org/dtd/spring-beans.dtd">

<beans>

    <!-- load common properties -->
    <bean id="virtserver-properties" 
          class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="ignoreUnresolvablePlaceholders">
            <value>true</value>
        </property>
        <property name="locations">
            <list>
                <value>file:${catalina.base}/conf/alfresco-shared.properties</value>
                <value>file:${catalina.base}/conf/alfresco-virtserver.properties</value>
            </list>
        </property>
    </bean>

    <!-- The remote authentication service. -->
    <bean id="authenticationService" class="org.springframework.remoting.rmi.RmiProxyFactoryBean">
        <property name="serviceUrl">
            <value>rmi://${avm.remote.host}:${avm.remote.port}/authentication</value>
        </property>
        <property name="serviceInterface">
            <value>org.alfresco.service.cmr.security.AuthenticationService</value>
        </property>
        <property name="refreshStubOnConnectFailure">
            <value>true</value>
        </property>
    </bean>

    <!-- Remote Alfresco RMI Proxy bean -->
    <bean id="avmRemote" class="org.alfresco.repo.remote.AVMRemoteImpl">
        <property name="avmRemoteTransport">
            <ref bean="avmRemoteTransport"/>
        </property>
    </bean>
    
    <!-- The underlying transport. -->
    <bean id="avmRemoteTransport" class="org.springframework.remoting.rmi.RmiProxyFactoryBean">
        <property name="serviceUrl">
            <value>rmi://${avm.remote.host}:${avm.remote.port}/avm</value>
        </property>

        <property name="serviceInterface">
            <value>org.alfresco.service.cmr.remote.AVMRemoteTransport</value>
        </property>

        <property name="refreshStubOnConnectFailure">
            <value>true</value>
        </property>
    </bean>

    <!-- The JNDI info bean for jndi-client specific property access -->
    <bean id="jndiInfoBean" class="org.alfresco.jndi.JndiInfoBean">
    	<property name="alfrescoServerUser">
    	    <value>${alfresco.server.user}</value>
    	</property>
    	<property name="alfrescoServerPassword">
    		<value>${alfresco.server.password}</value>
        </property>
    </bean>

    <!-- Info for peer/peer MBean registration with remote Alfresco server -->
    <bean id="virtServerInfo" 
          class="org.alfresco.mbeans.VirtServerInfo"
          lazy-init="true">

        <!-- local virtualization server hostname -->
        <property name="virtServerJmxRmiHost">
            <value>${alfresco.virtserver.host}</value>
        </property>

        <!-- local virtualization server JMX RMI port  -->
        <property name="virtServerJmxRmiPort">
            <value>${alfresco.virtserver.port}</value>
        </property>


        <!-- remote Alfresco server hostname -->
        <property name="alfrescoJmxRmiHost">
            <value>${avm.remote.host}</value>
        </property>

        <!-- remote Alfresco server JMX RMI port -->
        <property name="alfrescoJmxRmiPort">
            <value>${avm.jmxrmi.port}</value>
        </property>
    </bean>


    <!-- Custom MBeanServer                                    -->
    <!--                                                       -->
    <!-- Note:                                                 --> 
    <!--   The Alfresco servlet container performs callbacks   -->
    <!--   to this MBeanServer when critical events happen,    -->
    <!--   such as a modification to a jar/class in WEB-INF,   -->
    <!--   or a change to a webapp's WEB-INF/web.xml;          -->
    <!--   when this happens, the virtualization server        -->
    <!--   needs to reload the webapp, and any webapps         -->
    <!--   that depend on it (e.g.: webapps corresponding      -->
    <!--   to sandboxes that aren't "staging").                -->
    <bean id="virtServerMBeanServer" class="org.springframework.jmx.support.MBeanServerFactoryBean"/>

    <bean id="virtServerRegistry"   class="org.springframework.remoting.rmi.RmiRegistryFactoryBean">
        <property name="port" value="${alfresco.virtserver.port}"/>
    </bean>

    <!-- MBeanServer Connector (registers itself with custom virtServerMBeanServer) -->
    <bean id="serverConnector" 
          class="org.springframework.jmx.support.ConnectorServerFactoryBean"
          depends-on="virtServerRegistry">

        <property name="server"      ref="virtServerMBeanServer"/>
        <property name="objectName"  value="connector:name=rmi"/>
        <property name="serviceUrl"  value="service:jmx:rmi://localhost/jndi/rmi://localhost:${alfresco.virtserver.port}/alfresco/jmxrmi" />

        <property name="environment">
            <map>
                <!-- The following keys are only valid when sun jmx is used -->
                <entry key="jmx.remote.x.password.file" value="${catalina.base}/conf/alfresco-jmxrmi.password"/>
                <entry key="jmx.remote.x.access.file"   value="${catalina.base}/conf/alfresco-jmxrmi.access"/>
            </map>
        </property>
    </bean>

    <bean id="virtServerExporter" class="org.springframework.jmx.export.MBeanExporter">
       <property name="server" ref="virtServerMBeanServer"/>
       <property name="beans">
         <map>
           <!-- MBeans to register with virtServerMBeanServer -->
           <entry key="Alfresco:Name=VirtWebappRegistry,Type=VirtWebappRegistry" value-ref="virtWebappRegistry"/>
         </map>
       </property>
     </bean>

    <!-- MBeans registered with virtServerMBeanServer -->
    <bean id="virtWebappRegistry" class="org.alfresco.mbeans.VirtWebappRegistry">
        <property name="moo" value="1"/>
    </bean>

</beans>
