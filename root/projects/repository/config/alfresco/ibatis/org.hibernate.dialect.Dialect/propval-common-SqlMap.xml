<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="alfresco.propval">

    <!--                -->
    <!-- Type Defs      -->
    <!--                -->
    
    <typeAlias alias="PropertyClass" type="org.alfresco.repo.domain.propval.PropertyClassEntity"/>
    <typeAlias alias="PropertyDateValue" type="org.alfresco.repo.domain.propval.PropertyDateValueEntity"/>
    <typeAlias alias="PropertyStringValue" type="org.alfresco.repo.domain.propval.PropertyStringValueEntity"/>
    <typeAlias alias="PropertyDoubleValue" type="org.alfresco.repo.domain.propval.PropertyDoubleValueEntity"/>
    <typeAlias alias="PropertyValue" type="org.alfresco.repo.domain.propval.PropertyValueEntity"/>
    <typeAlias alias="PropertyLink" type="org.alfresco.repo.domain.propval.PropertyLinkEntity"/>
    <typeAlias alias="PropertyIdSearchRow" type="org.alfresco.repo.domain.propval.PropertyIdSearchRow"/>

    <!--                -->
    <!-- Result Maps    -->
    <!--                -->

    <resultMap id="result.PropertyClass" class="PropertyClass">
        <result property="id" column="id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="javaClassName" column="java_class_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
        <result property="javaClassNameShort" column="java_class_name_short" jdbcType="VARCHAR" javaType="java.lang.String"/>
        <result property="javaClassNameCrc" column="java_class_name_crc" jdbcType="BIGINT" javaType="java.lang.Long"/>
    </resultMap>
    <resultMap id="result.PropertyDateValue" class="PropertyDateValue">
        <!--  date_value is the PK as well -->
        <result property="dateValue" column="date_value" jdbcType="BIGINT" javaType="long"/>
        <result property="fullYear" column="full_year" jdbcType="SMALLINT" javaType="short"/>
        <result property="halfOfYear" column="half_of_year" jdbcType="TINYINT" javaType="short"/>
        <result property="quarterOfYear" column="quarter_of_year" jdbcType="TINYINT" javaType="short"/>
        <result property="monthOfYear" column="month_of_year" jdbcType="TINYINT" javaType="short"/>
        <result property="weekOfYear" column="week_of_year" jdbcType="TINYINT" javaType="short"/>
        <result property="weekOfMonth" column="week_of_month" jdbcType="TINYINT" javaType="short"/>
        <result property="dayOfYear" column="day_of_year" jdbcType="SMALLINT" javaType="short"/>
        <result property="dayOfMonth" column="day_of_month" jdbcType="TINYINT" javaType="short"/>
        <result property="dayOfWeek" column="day_of_week" jdbcType="TINYINT" javaType="short"/>
    </resultMap>
    <resultMap id="result.PropertyStringValue" class="PropertyStringValue">
        <result property="id" column="id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="stringValue" column="string_value" jdbcType="VARCHAR" javaType="java.lang.String"/>
        <result property="stringEndLower" column="string_end_lower" jdbcType="VARCHAR" javaType="java.lang.String"/>
        <result property="stringCrc" column="string_crc" jdbcType="BIGINT" javaType="java.lang.Long"/>
    </resultMap>
    <resultMap id="result.PropertyDoubleValue" class="PropertyDoubleValue">
        <result property="id" column="id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="doubleValue" column="double_value" jdbcType="DOUBLE" javaType="java.lang.Double"/>
    </resultMap>
    <resultMap id="result.PropertyValue" class="PropertyValue">
        <result property="id" column="id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="actualTypeId" column="actual_type_id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="persistedType" column="persisted_type" jdbcType="TINYINT" javaType="java.lang.Short"/>
        <result property="longValue" column="long_value" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="doubleValue" column="double_value" jdbcType="DOUBLE" javaType="java.lang.Double"/>
        <result property="stringValue" column="string_value" jdbcType="VARCHAR" javaType="java.lang.String"/>
        <result property="serializableValue" column="serializable_value" jdbcType="BLOB" javaType="java.lang.Object"/>
    </resultMap>
    <resultMap id="result.PropertyLink" class="PropertyLink">
        <result property="rootPropId" column="root_prop_id" jdbcType="BIGINT" javaType="long"/>
        <result property="currentPropId" column="current_prop_id" jdbcType="BIGINT" javaType="long"/>
        <result property="valuePropId" column="value_prop_id" jdbcType="BIGINT" javaType="long"/>
        <result property="keyPropId" column="key_prop_id" jdbcType="BIGINT" javaType="long"/>
    </resultMap>
    <resultMap id="result.PropertyIdSearchRow" class="PropertyIdSearchRow">
        <result property="rootPropId" column="root_prop_id" jdbcType="BIGINT" javaType="long"/>
        <result property="currentPropId" column="current_prop_id" jdbcType="BIGINT" javaType="long"/>
        <result property="valuePropId" column="value_prop_id" jdbcType="BIGINT" javaType="long"/>
        <result property="keyPropId" column="key_prop_id" jdbcType="BIGINT" javaType="long"/>
        <result property="actualTypeId" column="actual_type_id" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="persistedType" column="persisted_type" jdbcType="TINYINT" javaType="java.lang.Short"/>
        <result property="longValue" column="long_value" jdbcType="BIGINT" javaType="java.lang.Long"/>
        <result property="doubleValue" column="double_value" jdbcType="DOUBLE" javaType="java.lang.Double"/>
        <result property="stringValue" column="string_value" jdbcType="VARCHAR" javaType="java.lang.String"/>
        <result property="serializableValue" column="serializable_value" jdbcType="BLOB" javaType="java.lang.Object"/>
    </resultMap>
  
    <!--                -->
    <!-- Parameter Maps -->
    <!--                -->

    <!--                -->
    <!-- SQL Snippets   -->
    <!--                -->
    
    <sql id="insert.PropertyClass.AutoIncrement">
        insert into alf_prop_class (java_class_name, java_class_name_short, java_class_name_crc) 
        values (#javaClassName#, #javaClassNameShort#, #javaClassNameCrc#)
    </sql>
    
    <sql id="insert.PropertyStringValue.AutoIncrement">
        insert into alf_prop_string_value (string_value, string_end_lower, string_crc) 
        values (#stringValue#, #stringEndLower#, #stringCrc#)
    </sql>
    
    <sql id="insert.PropertyDoubleValue.AutoIncrement">
        insert into alf_prop_double_value (double_value) 
        values (#doubleValue#)
    </sql>
    
    <sql id="insert.PropertyValue.AutoIncrement">
        insert into alf_prop_value (actual_type_id, persisted_type, long_value) 
        values (#actualTypeId#, #persistedType#, #longValue#)
    </sql>
    
    <!--                -->
    <!-- Statements     -->
    <!--                -->
    
    <!-- Get a property class by ID -->
    <select id="select.PropertyClassByID" parameterClass="PropertyClass" resultMap="result.PropertyClass">
        select
            *
        from
            alf_prop_class
        where
            id = #id#
    </select>

    <!-- Get the property class by class name -->
    <select id="select.PropertyClassByName" parameterClass="PropertyClass" resultMap="result.PropertyClass">
        select
            *
        from
            alf_prop_class
        where
            java_class_name_crc = #javaClassNameCrc# and
            java_class_name_short = #javaClassNameShort#
    </select>

    <insert id="insert.PropertyDateValue" parameterClass="PropertyDateValue" >
        insert into alf_prop_date_value
        (
           date_value,
           full_year, half_of_year, quarter_of_year,
           month_of_year,
           week_of_year, week_of_month,
           day_of_year, day_of_month, day_of_week
        ) 
        values
        (
           #dateValue#,
           #fullYear#, #halfOfYear#, #quarterOfYear#,
           #monthOfYear#,
           #weekOfYear#, #weekOfMonth#,
           #dayOfYear#, #dayOfMonth#, #dayOfWeek#
        )
    </insert>

    <!-- Get a property date value by ID -->
    <select id="select.PropertyDateValueByID" parameterClass="java.lang.Long" resultMap="result.PropertyDateValue">
        select
            *
        from
            alf_prop_date_value
        where
            date_value = #dateValue#
    </select>

    <!-- Get the property date value by value -->
    <select id="select.PropertyDateValueByValue" parameterClass="java.lang.Long" resultMap="result.PropertyDateValue">
        select
            *
        from
            alf_prop_date_value
        where
            date_value = #dateValue#
    </select>

    <!-- Get a property string value by ID -->
    <select id="select.PropertyStringValueByID" parameterClass="PropertyStringValue" resultClass="string">
        select
            string_value
        from
            alf_prop_string_value
        where
            id = #id#
    </select>

    <!-- Get the property string value by value 
    -->
    <select id="select.PropertyStringValueByValue" parameterClass="PropertyStringValue" resultClass="java.lang.Long">
        select
            id
        from
            alf_prop_string_value
        where
            string_end_lower = #stringEndLower# and
            string_crc = #stringCrc#
    </select>

    <!-- Get a property double value by ID -->
    <select id="select.PropertyDoubleValueByID" parameterClass="PropertyDoubleValue" resultMap="result.PropertyDoubleValue">
        select
            *
        from
            alf_prop_double_value
        where
            id = #id#
    </select>

    <!-- Get the property double value by value -->
    <select id="select.PropertyDoubleValueByValue" parameterClass="PropertyDoubleValue" resultMap="result.PropertyDoubleValue">
        select
            *
        from
            alf_prop_double_value
        where
            double_value = #doubleValue#
    </select>

    <!-- Get the property value by value in alf_prop_value -->
    <select id="select.PropertyValueByLocalValue" parameterClass="PropertyValue" resultMap="result.PropertyValue">
        select
            pv.id as id,
            pv.actual_type_id as actual_type_id,
            pv.persisted_type as persisted_type,
            pv.long_value as long_value,
            null as double_value,
            null as string_value,
            null as serializable_value
        from
            alf_prop_value pv
        where
            pv.actual_type_id = #actualTypeId# and
            pv.long_value = #longValue#
    </select>

    <!-- Get the property value by value in alf_prop_double_value -->
    <select id="select.PropertyValueByDoubleValue" parameterClass="PropertyValue" resultMap="result.PropertyValue">
        select
            pv.id as id,
            pv.actual_type_id as actual_type_id,
            pv.persisted_type as persisted_type,
            pv.long_value as long_value,
            dv.double_value as double_value,
            null as string_value,
            null as serializable_value
        from
            alf_prop_value pv
            join alf_prop_double_value dv on (dv.id = pv.long_value and pv.persisted_type = #persistedType#)
        where
            pv.actual_type_id = #actualTypeId# and
            dv.double_value = #doubleValue#
    </select>

    <!-- Get the property value by value in alf_prop_string_value -->
    <select id="select.PropertyValueByStringValue" parameterClass="PropertyValue" resultMap="result.PropertyValue">
        select
            pv.id as id,
            pv.actual_type_id as actual_type_id,
            pv.persisted_type as persisted_type,
            pv.long_value as long_value,
            null as double_value,
            sv.string_value as string_value,
            null as serializable_value
        from
            alf_prop_value pv
            join alf_prop_string_value sv on (sv.id = pv.long_value and pv.persisted_type = #persistedType#)
        where
            pv.actual_type_id = #actualTypeId# and
            sv.string_value = #stringValue#
    </select>

    <!-- Get the property value by ID -->
    <select id="select.PropertyValueById" parameterClass="PropertyValue" resultMap="result.PropertyIdSearchRow">
		select
		   cl.root_prop_id, cl.current_prop_id, cl.value_prop_id, cl.key_prop_id,
		   v.actual_type_id, v.persisted_type,
		   v.long_value, dv.double_value, sv.string_value, serv.serializable_value
		from
		   alf_prop_link cl
		   join alf_prop_value v on (cl.value_prop_id = v.id)
		   left join alf_prop_double_value dv on (dv.id = v.long_value and v.persisted_type = 2)
		   left join alf_prop_string_value sv on (sv.id = v.long_value and (v.persisted_type = 3 || v.persisted_type = 5))
		   left join alf_prop_serializable_value serv on (serv.id = v.long_value and v.persisted_type = 4)
		where cl.root_prop_id = #id#
		order by current_prop_id, value_prop_id, key_prop_id
    </select>

    <insert id="insert.PropertyLink" parameterClass="PropertyLink" >
        insert into alf_prop_link
        (
           root_prop_id, current_prop_id, value_prop_id, key_prop_id
        )
        values
        (
           #rootPropId#, #currentPropId#, #valuePropId#, #keyPropId#
        )
    </insert>

</sqlMap>