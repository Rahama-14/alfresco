<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>

<beans>

    <bean id="PatchService" class="org.springframework.aop.framework.ProxyFactoryBean">
    	<property name="proxyInterfaces">
    		<value>org.alfresco.repo.admin.patch.PatchService</value>
    	</property>
    	<property name="target"><ref bean="patchComponent"/></property>
    	<property name="interceptorNames">
            <list>
                <idref local="PatchService_transaction" />
    		</list>
    	</property>
    </bean>

    <bean id="PatchService_transaction" class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
        <property name="transactionAttributes">
            <props>
                <prop key="get*">${server.transaction.mode.readOnly}</prop>
                <prop key="*">${server.transaction.mode.default}</prop>
            </props>
        </property>
    </bean>
    
    <bean id="patchDaoComponent" class="org.alfresco.repo.admin.patch.hibernate.HibernatePatchDaoServiceImpl" >
        <property name="sessionFactory">
            <ref bean="sessionFactory" />
        </property>
    </bean>
    
    <bean id="patchComponent" class="org.alfresco.repo.admin.patch.PatchServiceImpl" >
        <property name="descriptorService">
            <ref bean="descriptorComponent" />
        </property>
        <property name="patchDaoService">
            <ref bean="patchDaoComponent" />
        </property>
    </bean>

    <!-- base patch definition -->
    <bean id="basePatch" abstract="true" depends-on="patchComponent" init-method="init">
        <property name="patchService">
            <ref bean="patchComponent" />
        </property>
        <property name="transactionService">
            <ref bean="transactionComponent" />
        </property>
    </bean>
    
    <!-- Example patches -->
    <bean id="patch.sample.01" class="org.alfresco.repo.admin.patch.SamplePatch" parent="basePatch" >
        <property name="id"><value>Sample01</value></property>
        <property name="description"><value>A NO-OP sample patch</value></property>
        <property name="fixesFromSchema"><value>0</value></property>
        <property name="fixesToSchema"><value>1000</value></property>
        <property name="targetSchema"><value>1001</value></property>
    </bean>
    <bean id="patch.sample.02" class="org.alfresco.repo.admin.patch.SamplePatch" parent="basePatch" >
        <property name="id"><value>Sample02</value></property>
        <property name="description"><value>A NO-OP sample patch</value></property>
        <property name="fixesFromSchema"><value>0</value></property>
        <property name="fixesToSchema"><value>1000</value></property>
        <property name="targetSchema"><value>1001</value></property>
        <property name="dependsOn" >
            <list>
                <ref bean="patch.sample.01" />
            </list>
        </property>
    </bean>

    <!--              -->
    <!-- Helper beans -->
    <!--              -->
    
    <bean id="patch.savedSearches.Base" abstract="true" parent="basePatch" >
        <!-- helper beans for execution -->
        <property name="importerBootstrap">
            <ref bean="importerBootstrap" />
        </property>
        <property name="namespaceService">
            <ref bean="namespaceService" />
        </property>
        <property name="searchService">
            <ref bean="searchService" />
        </property>
        <property name="nodeService">
            <ref bean="nodeService"/>
        </property>
    </bean>

    <bean id="bootstrapSpacesMessageSource" class="org.springframework.context.support.ResourceBundleMessageSource">
        <property name="basenames">
            <list>
                <value>alfresco/messages/bootstrap-spaces</value> 
            </list>
        </property>
    </bean>
    
    <!--                   -->
    <!-- Patch definitions -->
    <!--                   -->
    
    <bean id="patch.savedSearchesFolder" class="org.alfresco.repo.admin.patch.impl.SavedSearchFolderPatch" parent="patch.savedSearches.Base" >
        <property name="id"><value>patch.savedSearchesFolder</value></property>
        <property name="description"><value>patch.savedSearchesFolder.description</value></property>
        <property name="fixesFromSchema"><value>0</value></property>
        <property name="fixesToSchema"><value>1</value></property>
        <property name="targetSchema"><value>2</value></property>
        <!-- helper beans for execution -->
        <property name="messageSource">
            <ref bean="bootstrapSpacesMessageSource" />
        </property>   
    </bean>
    <bean id="patch.savedSearchesPermission" class="org.alfresco.repo.admin.patch.impl.SavedSearchPermissionPatch" parent="patch.savedSearches.Base" >
        <property name="id"><value>patch.savedSearchesPermission</value></property>
        <property name="description"><value>patch.savedSearchesPermission.description</value></property>
        <property name="fixesFromSchema"><value>0</value></property>
        <property name="fixesToSchema"><value>4</value></property>
        <property name="targetSchema"><value>5</value></property>
        <!-- helper beans for execution -->
        <property name="permissionService">
            <ref bean="permissionService"/>
        </property>
        <!-- dependent on presence of saved searches folder -->
        <property name="dependsOn" >
            <list>
                <ref bean="patch.savedSearchesFolder" />
            </list>
        </property>
    </bean>
    <bean id="patch.updatePermissionData" class="org.alfresco.repo.admin.patch.impl.PermissionDataPatch" parent="basePatch" >
        <property name="id"><value>patch.updatePermissionData</value></property>
        <property name="description"><value>patch.updatePermissionData.description</value></property>
        <property name="fixesFromSchema"><value>0</value></property>
        <property name="fixesToSchema"><value>2</value></property>
        <property name="targetSchema"><value>3</value></property>
        <!-- helper beans -->
        <property name="sessionFactory">
            <ref bean="sessionFactory" />
        </property>
    </bean>
    <bean id="patch.guestUser" class="org.alfresco.repo.admin.patch.impl.GuestUserPatch" parent="basePatch" >
        <property name="id"><value>patch.guestUser</value></property>
        <property name="description"><value>patch.guestUser.description</value></property>
        <property name="fixesFromSchema"><value>0</value></property>
        <property name="fixesToSchema"><value>2</value></property>
        <property name="targetSchema"><value>3</value></property>
        <!-- helper beans -->
        <property name="searchService">
            <ref bean="searchService" />
        </property>
        <property name="nodeService">
            <ref bean="nodeService"/>
        </property>
        <property name="personService">
            <ref bean="personService"/>
        </property>
        <property name="permissionService">
            <ref bean="permissionService"/>
        </property>
        <property name="importerBootstrap">
            <ref bean="importerBootstrap" />
        </property>
        <property name="namespaceService">
            <ref bean="namespaceService" />
        </property>
        <property name="messageSource">
            <ref bean="bootstrapSpacesMessageSource" />
        </property>   
    </bean>
    <bean id="patch.fixNodeSerializableValues" class="org.alfresco.repo.admin.patch.impl.NodePropertySerializablePatch" parent="basePatch" >
        <property name="id"><value>patch.fixNodeSerializableValues</value></property>
        <property name="description"><value>patch.fixNodeSerializableValues.description</value></property>
        <property name="fixesFromSchema"><value>0</value></property>
        <property name="fixesToSchema"><value>3</value></property>
        <property name="targetSchema"><value>4</value></property>
        <!-- helper beans -->
        <property name="sessionFactory">
            <ref bean="sessionFactory" />
        </property>
    </bean>

    <!-- This component ensures that patches get applied on startup -->
    <!-- The order is important here.  All the self-registering patches must be defined before this bean -->
    <bean id="patchExecuter"
            class="org.alfresco.repo.admin.patch.PatchExecuter"
            depends-on="importerBootstrap"
            init-method="applyOutstandingPatches">
        <property name="patchService">
            <ref bean="PatchService" />
        </property>
    </bean>
    
</beans>
