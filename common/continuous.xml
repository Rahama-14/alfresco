<project name="continuous" default="continuous" >

   <!-- ********************************** -->
   <!-- ** Initialisation/Configuration ** -->
   <!-- ********************************** -->

   <property name="dir.common" value="${basedir}/build-scripts" />
   <import file="${dir.common}/common-init.xml" />

   <target name="init" depends="common-init.init">
      <property name="file.name.start" value="alfresco"/>
      <property file="continuous.properties"/>
      <property name="file.name.build" value="build.xml"/>
      <property name="excludes.dist.src" value="${excludes.dist.src.open}"/>
   </target>

   <!-- *********************** -->
   <!-- ** Top level targets ** -->
   <!-- *********************** -->
   
   <target name="continuous" depends="init" description="Target called by the continuous build to create distribution bundles">
      <ant antfile="${file.name.build}" target="reset-database"/>
      <ant antfile="${file.name.build}" target="test"/>
      <antcall target="distribute"/>
   </target>

   <target name="nightly" depends="init" description="Target called by the continuous build to create the nightly distribution">
      <ant antfile="${file.name.build}" target="reset-database"/>
      <ant antfile="${file.name.build}" target="test"/>
      <antcall target="distribute-source"/>
      
      <!-- replace the version number in the file name with the date -->
      <move file="${dir.dist}/${file.name.dist.src}.zip" tofile="${dir.dist}/${file.name.dist.src.nightly}.zip"/>
      <move file="${dir.dist}/${file.name.dist.src}.tar.gz" tofile="${dir.dist}/${file.name.dist.src.nightly}.tar.gz"/>
      
      <ant antfile="${file.name.build}" target="compile-docs"/>
      <!--<antcall target="generate-checksums"/>-->
   </target>

   <target name="distribute" 
           depends="init, distribute-jboss, distribute-tomcat, distribute-war, distribute-source, generate-checksums"
           description="Creates the distribution files for all platforms for all appservers"/>

   <target name="generate-checksums" depends="init" 
           description="Generates checksum files for the distibution files">
      <delete>
         <fileset dir="${dir.dist}" includes="*.MD5"/>
      </delete>
      <checksum>
         <fileset dir="${dir.dist}"/>
      </checksum>
   </target>
   
   <!-- ******************* -->
   <!-- ** JBoss targets ** -->
   <!-- ******************* -->
   
   <target name="distribute-jboss" depends="init" description="Creates the distibution files for JBoss">
      <ant antfile="${file.name.build}" target="clean-war" />
      <ant antfile="${file.name.build}" target="incremental-jboss" />
      <antcall target="assemble-jboss-common" />
      <antcall target="distribute-jboss-windows" />
      <antcall target="distribute-jboss-linux" />
   </target>
   
   <target name="distribute-jboss-windows" depends="init">
      <zip destfile="${dir.dist}/${file.name.dist.jboss}.zip">
         <zipfileset dir="${dir.assemble.jboss}" />
         <zipfileset dir="${dir.project.installer}" includes="${files.installer.windows}" />
         <zipfileset dir="${dir.project.installer}" includes="jboss/alfresco.bat" fullpath="alfresco.bat" />
         <zipfileset dir="${dir.project.installer}" includes="jboss/README_win.txt" fullpath="README.txt" />
         <zipfileset dir="${dir.distribution.jboss}" prefix="jboss" excludes="**/bin/*.sh" />
         <zipfileset dir="${dir.project.installer}/bin-win" prefix="bin"/>
         <zipfileset dir="${dir.project.netbios}/dll" prefix="bin"/>
      </zip>
   </target>

   <target name="distribute-jboss-linux" depends="init">
      <tar destfile="${dir.dist}/${file.name.dist.jboss}.tar" longfile="gnu">
         <tarfileset dir="${dir.assemble.jboss}" />
         <tarfileset dir="${dir.project.installer}" includes="${files.installer.linux}" />
         <tarfileset dir="${dir.project.installer}" includes="jboss/alfresco.sh" fullpath="alfresco.sh" mode="755" />
         <tarfileset dir="${dir.project.installer}" includes="jboss/README_linux.txt" fullpath="README.txt" />
         <tarfileset dir="${dir.project.installer}" includes="jboss/README_osx.txt" fullpath="README_osx.txt" />
         <tarfileset dir="${dir.project.installer}" includes="zstart_oo.sh" mode="755" />
         <tarfileset dir="${dir.distribution.jboss}" prefix="jboss" excludes="**/bin/*.bat" />
         <tarfileset dir="${dir.distribution.jboss}/bin" prefix="jboss/bin" includes="*.sh" mode="755" />
      </tar>
      <gzip zipfile="${dir.dist}/${file.name.dist.jboss}.tar.gz" src="${dir.dist}/${file.name.dist.jboss}.tar" />
      <delete file="${dir.dist}/${file.name.dist.jboss}.tar" />
   </target>
   
   <target name="assemble-jboss-common" depends="init">
      <mkdir dir="${dir.dist}" />
      <mkdir dir="${dir.assemble.jboss}" />
      
      <!-- make sure the MySQL connector is present and up to date -->
      <delete>
         <fileset dir="${dir.distribution.jboss}/server/default/lib" includes="mysql-connector*" excludes="${file.name.mysql.connector}"/>
      </delete>
      <copy todir="${dir.distribution.jboss}/server/default/lib" file="${dir.common.lib}/${file.name.mysql.connector}"/>
      
      <!-- copy project files common to both platforms -->
      <copy todir="${dir.assemble.jboss}/jboss/server/default/deploy">
         <fileset dir="${dir.deploy.jboss}" includes="${file.name.war.alfresco}" />
      </copy>
      <copy todir="${dir.assemble.jboss}/jboss/server/default/conf">
         <fileset dir="${dir.config.repository}" />
         <fileset dir="${dir.config.webclient}" />
      </copy>
   </target>

   <!-- ******************** -->
   <!-- ** Tomcat targets ** -->
   <!-- ******************** -->
   
   <target name="distribute-tomcat" depends="init" description="Creates the distibution files for Tomcat">
      <ant antfile="${file.name.build}" target="clean-war"/>
      <ant antfile="${file.name.build}" target="incremental-tomcat"/>
      <antcall target="assemble-tomcat-common" />
      <antcall target="distribute-tomcat-windows" />
      <antcall target="distribute-tomcat-linux" />
   </target>

   <target name="distribute-tomcat-windows" depends="init">
      <zip destfile="${dir.dist}/${file.name.dist.tomcat}.zip">
         <zipfileset dir="${dir.assemble.tomcat}" />
         <zipfileset dir="${dir.project.installer}" includes="${files.installer.windows}" />
         <zipfileset dir="${dir.project.installer}" includes="tomcat/alfresco.bat" fullpath="alfresco.bat" />
         <zipfileset dir="${dir.project.installer}" includes="tomcat/README_win.txt" fullpath="README.txt" />
         <zipfileset dir="${dir.distribution.tomcat}" prefix="tomcat" excludes="**/bin/*.sh" />
         <zipfileset dir="${dir.project.installer}/bin-win" prefix="bin"/>
         <zipfileset dir="${dir.project.netbios}/dll" prefix="bin"/>
      </zip>
   </target>
   
   <target name="distribute-tomcat-linux" depends="init">
      <tar destfile="${dir.dist}/${file.name.dist.tomcat}.tar" longfile="gnu">
         <tarfileset dir="${dir.assemble.tomcat}" />
         <tarfileset dir="${dir.project.installer}" includes="${files.installer.linux}" />
         <tarfileset dir="${dir.project.installer}" includes="tomcat/alfresco.sh" fullpath="alfresco.sh" mode="755" />
         <tarfileset dir="${dir.project.installer}" includes="tomcat/README_linux.txt" fullpath="README.txt" />
         <tarfileset dir="${dir.project.installer}" includes="tomcat/README_osx.txt" fullpath="README_osx.txt" />
         <tarfileset dir="${dir.project.installer}" includes="zstart_oo.sh" mode="755" />
         <tarfileset dir="${dir.distribution.tomcat}" prefix="tomcat" excludes="**/bin/*.sh,**/bin/*.bat" />
         <tarfileset dir="${dir.distribution.tomcat}/bin" prefix="tomcat/bin" includes="*.sh" mode="755" />
      </tar>
      <gzip zipfile="${dir.dist}/${file.name.dist.tomcat}.tar.gz" src="${dir.dist}/${file.name.dist.tomcat}.tar" />
      <delete file="${dir.dist}/${file.name.dist.tomcat}.tar" />
   </target>
   
   <target name="assemble-tomcat-common" depends="init">
      <mkdir dir="${dir.dist}" />
      <mkdir dir="${dir.assemble.tomcat}" />
      
      <!-- make sure the MySQL connector is present and up to date -->
      <delete>
         <fileset dir="${dir.distribution.tomcat}/common/lib" includes="mysql-connector*" excludes="${file.name.mysql.connector}"/>
      </delete>
      <copy todir="${dir.distribution.tomcat}/common/lib" file="${dir.common.lib}/${file.name.mysql.connector}" />
      
      <copy todir="${dir.assemble.tomcat}/tomcat/webapps">
         <fileset dir="${dir.deploy.tomcat}" includes="${file.name.war.alfresco}" />
      </copy>
   </target>
   
   <!-- ***************** -->
   <!-- ** WAR targets ** -->
   <!-- ***************** -->
   
   <target name="distribute-war" depends="assemble-war-common"
           description="Creates the WAR file distribution for all platforms">
      <mkdir dir="${dir.dist}" />
      <zip destfile="${dir.dist}/${file.name.dist.war}.zip">
         <zipfileset dir="${dir.assemble.war}" />
         <zipfileset dir="${dir.project.installer}/bin-win" prefix="bin"/>
         <zipfileset dir="${dir.project.netbios}/dll" prefix="bin"/>
      </zip>
      
      <tar destfile="${dir.dist}/${file.name.dist.war}.tar" longfile="gnu">
         <tarfileset dir="${dir.assemble.war}" />
      </tar>
      <gzip zipfile="${dir.dist}/${file.name.dist.war}.tar.gz" src="${dir.dist}/${file.name.dist.war}.tar" />
      <delete file="${dir.dist}/${file.name.dist.war}.tar" />
   </target>
   
   <target name="assemble-war-common" depends="init">
      <mkdir dir="${dir.assemble.war}"/>
      <copy todir="${dir.assemble.war}">
         <fileset dir="${dir.project.installer}" includes="*.sql,licenses/**,AlfrescoTest.pdf, README_war.txt" />
         <fileset dir="${dir.deploy.tomcat}" includes="${file.name.war.alfresco}"/>
      </copy>
   </target>
   
   <!-- ******************** -->
   <!-- ** Source targets ** -->
   <!-- ******************** -->
   
   <target name="distribute-source" depends="init"
           description="Creates the source distribution file for all platforms">
      <mkdir dir="${dir.dist}" />
      
      <zip destfile="${dir.dist}/${file.name.dist.src}.zip">
         <zipfileset dir="${dir.common}" excludes="${excludes.dist.src}" />
      </zip>
      
      <tar destfile="${dir.dist}/${file.name.dist.src}.tar" longfile="gnu">
         <tarfileset dir="${dir.common}" excludes="${excludes.dist.src}" />
      </tar>
      <gzip zipfile="${dir.dist}/${file.name.dist.src}.tar.gz" src="${dir.dist}/${file.name.dist.src}.tar" />
      <delete file="${dir.dist}/${file.name.dist.src}.tar" />
   </target>

</project>
