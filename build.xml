<project name="alfresco" default="build-all">

   <!-- Checking the SVN SWITCH -->

   <property name="common.dir" value="${basedir}" />
   <import file="${common.dir}/common-init.xml" />

   <!--
   NOTE: There is no guaranteed order the projects will be executed in the targets below, to define 
         an explicit order use a filelist instead of a fileset.
   -->
   <filelist id="project-build-files" dir="."
         files="projects/core/project-build.xml
                projects/repository/project-build.xml
                projects/web-client/project-build.xml"/>

   <target name="build-all" depends="common-init" description="Builds all the projects after cleaning">
      <subant target="build">
         <filelist refid="project-build-files"/>
      </subant>
      <antcall target="deploy" />
   </target>

   <target name="incremental-all" depends="common-init" description="Builds all the projects">
      <subant target="incremental">
         <filelist refid="project-build-files"/>
      </subant>
      <antcall target="deploy" />
   </target>

   <target name="test-all" depends="common-init" description="Runs unit tests for all the projects">
      <subant target="run-tests">
         <filelist refid="project-build-files"/>
      </subant>
   </target>

   <target name="clean-all" depends="common-init" description="Cleans all the projects">
      <subant target="clean">
         <filelist refid="project-build-files"/>
      </subant>
   </target>

   <target name="deploy" depends="common-init" description="Deploys to JBoss">
      <copy file="${basedir}/projects/web-client/build/dist/web-client.ear" todir="${deploy.dir}" />
   </target>

   <target name="deploy-tomcat" depends="common-init" description="Deploys to Tomcat">
      <delete dir="${tomcat.home}/webapps/web-client" includeEmptyDirs="true" quiet="yes" />
      <delete dir="${tomcat.home}/work/catalina/localhost/web-client" includeEmptyDirs="true" quiet="yes" />
      <copy file="${basedir}/projects/web-client/build/dist/web-client.war" todir="${tomcat.home}/webapps" />
   </target>

   <target name="deploy-exploded-web-client-jboss" depends="common-init">
      <input message="Enter name of temporary JBoss folder" addproperty="jboss.tmp.deploy.dirname" />
      <property name="jboss.tmp.deploy.dir" value="${deploy.dir}/../tmp/deploy/${jboss.tmp.deploy.dirname}/web-client-exp.war" />
      <available file="${jboss.tmp.deploy.dir}" type="dir" property="jboss.tmp.deploy.dir.present" />
      <fail unless="jboss.tmp.deploy.dir.present"
            message="The temporary folder you entered does not exist, has JBoss been restarted?" />
      <copy todir="${jboss.tmp.deploy.dir}" verbose="true">
         <fileset dir="projects/web-client/source/web" excludes="WEB-INF/**" />
      </copy>
   </target>

   <target name="build-tomcat" depends="common-init">
      <subant target="build">
         <filelist refid="project-build-files"/>
      </subant>
      <antcall target="deploy-tomcat" />
   </target>

   <target name="incremental-tomcat" depends="common-init">
      <subant target="incremental">
         <filelist refid="project-build-files"/>
      </subant>
      <antcall target="deploy-tomcat" />
   </target>

   <target name="deploy-exploded-web-client-tomcat" depends="common-init">
      <copy todir="${tomcat.home}/webapps/web-client" verbose="true">
         <fileset dir="projects/web-client/source/web" excludes="WEB-INF/**" />
      </copy>
   </target>

   <target name="start-tomcat" depends="common-init" description="Starts the Tomcat server">
      <exec dir="${tomcat.home}/bin" executable="cmd.exe" spawn="true">
         <arg line="/k startup.bat" />
      </exec>
   </target>

   <target name="start-jboss" depends="common-init" description="Starts the JBoss server">
      <exec dir="${jboss.home}/bin" executable="cmd.exe" spawn="true">
         <arg line="/k start run.bat" />
      </exec>
   </target>

</project>