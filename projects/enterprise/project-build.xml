<project name="enterprise" default="build">

   <path id="path.common" path="${basedir}/../.."/>
   <property name="dir.common" refid="path.common"/>
   <import file="${dir.common}/common.xml"/>

   <target name="init" depends="common-init.init">
      <path id="classpath.unit.test.enterprise">
         <pathelement location="${basedir}/${dir.name.config}"/>
         <path refid="classpath.unit.test"/>
      </path>
   </target>

   <target name="package" depends="package-war" />

   <target name="package-war" depends="obfuscate">
      <!-- just add the JAR file to the existing WAR file -->
      <war warfile="${dir.project.webclient}/build/dist/${file.name.war.alfresco}" update="true" >
         <lib dir="${dir.common}/projects/enterprise/build/dist" includes="enterprise.jar" />
      </war>
   </target>
   
   <!-- obfuscate enterprise release build -->
   <target name="obfuscate" depends="package-jar" if="build.release">
      <taskdef name="obfuscate" classname="com.yworks.yguard.ObfuscatorTask" classpath="${dir.common.lib}/yguard.jar" />
      
      <obfuscate mainclass="${mainclass}" replaceclassnamestrings="true">
         <property name="error-checking" value="pedantic" />
         <property name="language-conformity" value="illegal" />
         <inoutpair in="${dir.dist}/${file.name.jar}" out="${dir.dist}/${file.name.jar}" />
         <externalclasses>
            <path refid="classpath.compile" />
         </externalclasses>
         <expose>
            <class classes="public" 
                   methods="protected" 
                   fields="public">
               <patternset>
                  <include name="**.*" />
                  <exclude name="org.alfresco.repo.security.permissions.impl.hibernate.*Impl"/>
               </patternset>
            </class>
            <class classes="public" 
                   methods="private" 
                   fields="public">
               <patternset>
                  <include name="org.alfresco.repo.security.permissions.impl.hibernate.*Impl"/>
               </patternset>
            </class>
            <attribute name="Deprecated" />
          </expose>
      </obfuscate>
   </target>
   
   <target name="run-tests" depends="package-jar" description="Runs the enterprise project unit tests">
        <mkdir dir="${dir.test.results}" />
        <junit printsummary="yes" fork="yes" haltonfailure="yes" dir="${basedir}">
            <classpath refid="classpath.unit.test.enterprise" />
            <formatter type="xml" />
            <batchtest todir="${dir.test.results}">
                <fileset dir="${dir.src.java}">
                    <include name="**/*Test.java" />
                    <exclude name="**/Base*Test.java" />
                    <exclude name="**/Abstract*Test.java" />
                    <exclude name="**/*SystemTest.java" />
                </fileset>
            </batchtest>
        </junit>
    </target>


</project>
