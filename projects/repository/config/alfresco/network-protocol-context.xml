<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>
 
<beans>
   <!-- File Server Configuration -->
   <bean id="fileServerConfiguration"
         class="org.alfresco.filesys.server.config.ServerConfiguration"
         init-method="init"
         destroy-method="closeConfiguration"
         depends-on="importerBootstrap">
      <constructor-arg>
         <ref bean="authenticationManager"/>
      </constructor-arg>
      <constructor-arg>
         <ref bean="authenticationService"/>
      </constructor-arg>
      <constructor-arg>
         <ref bean="authenticationComponent"/>
      </constructor-arg>
      <constructor-arg>
         <ref bean="nodeService"/>
      </constructor-arg>
      <constructor-arg>
         <ref bean="personService"/>
      </constructor-arg>
      <constructor-arg>
         <ref bean="transactionComponent"/>
      </constructor-arg>
      <constructor-arg>
         <value>alfresco/file-servers.xml</value>
      </constructor-arg>
      <constructor-arg>
         <ref bean="contentDiskDriver" />
      </constructor-arg>
   </bean>
   
   <!-- CIFS Server -->
   <bean id="cifsServer" class="org.alfresco.filesys.CIFSServer" init-method="startServer" destroy-method="stopServer" depends-on="importerBootstrap">
      <constructor-arg>
         <ref bean="fileServerConfiguration"/>
      </constructor-arg>
   </bean>
   
   <!-- FTP Server -->
   <bean id="ftpServer" class="org.alfresco.filesys.FTPServer" init-method="startServer" destroy-method="stopServer" depends-on="importerBootstrap">
      <constructor-arg>
         <ref bean="fileServerConfiguration"/>
      </constructor-arg>
   </bean>

   <!-- Filesystem Interface -->   
   <bean id="contentDiskDriver" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
      <property name="proxyInterfaces">
         <value>org.alfresco.filesys.smb.server.repo.ContentDiskInterface</value>
      </property>
      <property name="transactionManager"><ref bean="transactionManager"/></property>
      <property name="target">
         <bean class="org.alfresco.filesys.smb.server.repo.ContentDiskDriver" >
            <constructor-arg>
               <ref bean="cifsHelper" />
            </constructor-arg>
            <property name="transactionService"><ref bean="transactionComponent" /></property>
            <property name="nodeService"><ref bean="NodeService" /></property>
            <property name="unprotectedNodeService"><ref bean="nodeService" /></property>
            <property name="searchService"><ref bean="SearchService" /></property>
            <property name="unprotectedSearchService"><ref bean="searchService" /></property>
            <property name="dictionaryService"><ref bean="dictionaryService" /></property>
            <property name="namespaceService"><ref bean="namespaceService" /></property>
            <property name="mimetypeService"><ref bean="mimetypeMap" /></property>
            <property name="contentService"><ref bean="ContentService" /></property>
            <property name="permissionService"><ref bean="permissionService"/></property>
         </bean>
      </property>
      <property name="transactionAttributes">
         <props>
            <prop key="*exist">${server.transaction.mode.readOnly}</prop>
            <prop key="get*">${server.transaction.mode.readOnly}</prop>
            <prop key="is*">${server.transaction.mode.readOnly}</prop>
            <prop key="read*">${server.transaction.mode.readOnly}</prop>
            <prop key="seek*">${server.transaction.mode.readOnly}</prop>
            <prop key="start*">${server.transaction.mode.readOnly}</prop>
            <prop key="*">${server.transaction.mode.default}</prop>
         </props>
      </property>
      <!-- only enable for debugging
      <property name="postInterceptors">
         <list>
            <ref bean="methodCallLogAdvice" />
            <bean class="org.alfresco.util.perf.PerformanceMonitorAdvice" >
               <constructor-arg>
                  <value>contentDiskDriver</value>
               </constructor-arg>
            </bean>
         </list>
      </property>
      -->
   </bean>

   <bean id="contentDiskDriverNoTransactions" class="org.alfresco.filesys.smb.server.repo.ContentDiskDriver" >
         <constructor-arg>
            <ref bean="cifsHelper" />
         </constructor-arg>
         <property name="nodeService"><ref bean="nodeService" /></property>
         <property name="searchService"><ref bean="searchService" /></property>
         <property name="dictionaryService"><ref bean="dictionaryService" /></property>
         <property name="namespaceService"><ref bean="namespaceService" /></property>
         <property name="mimetypeService"><ref bean="mimetypeMap" /></property>
         <property name="contentService"><ref bean="contentService" /></property>
   </bean>
   
   <bean id="cifsHelper" class="org.alfresco.filesys.smb.server.repo.CifsHelper">
      <constructor-arg>
         <ref bean="dictionaryService"/>
      </constructor-arg>
      <constructor-arg>
         <ref bean="namespaceService"/>
      </constructor-arg>
         
      <property name="nodeService"><ref bean="NodeService" /></property>
      <property name="searchService"><ref bean="SearchService" /></property>
      <property name="mimetypeService"><ref bean="mimetypeMap" /></property>
      <property name="permissionService"><ref bean="permissionService"/></property>
      <!--
      <property name="filePathCache">
         <bean class="org.alfresco.filesys.server.filesys.cache.FilePathCache" >
            <property name="policyComponent">
               <ref bean="policyComponent" />
            </property>
            <property name="fileStatesCache" >
               <ref bean="fileStatesCache" />
            </property>
            <property name="pathResultsCache" >
               <ref bean="pathResultsCache" />
            </property>
         </bean>
      </property>
      -->
   </bean>

   <bean name="fileStatesCache" class="org.alfresco.repo.cache.TransactionalCache">
      <property name="cacheManager" >
         <ref bean="ehCacheManager" />
      </property>
      <property name="name">
         <value>cifs.transactional.fileStatesCache</value>
      </property>
      <property name="maxCacheSize">
         <value>20000</value>
      </property>
      <property name="sharedCache">
         <bean class="org.alfresco.repo.cache.EhCacheAdapter">
            <property name="cache">
               <bean class="org.springframework.cache.ehcache.EhCacheFactoryBean" >
                  <property name="cacheName">
                     <value>cifs.shared.fileStatesCache</value>
                  </property>
               </bean>
            </property>
         </bean>
      </property>
   </bean>
   
   <bean name="pathResultsCache" class="org.alfresco.repo.cache.TransactionalCache">
      <property name="cacheManager" >
         <ref bean="ehCacheManager" />
      </property>
      <property name="name">
         <value>cifs.transactional.pathResultsCache</value>
      </property>
      <property name="maxCacheSize">
         <value>20000</value>
      </property>
      <property name="sharedCache">
         <bean class="org.alfresco.repo.cache.EhCacheAdapter">
            <property name="cache">
               <bean class="org.springframework.cache.ehcache.EhCacheFactoryBean" >
                  <property name="cacheName">
                     <value>cifs.shared.pathResultsCache</value>
                  </property>
               </bean>
            </property>
         </bean>
      </property>
   </bean>
   
</beans>