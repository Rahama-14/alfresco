<?xml version='1.0' encoding='UTF-8'?>

<!DOCTYPE hibernate-mapping PUBLIC
    '-//Hibernate/Hibernate Mapping DTD 3.0//EN' 
    'http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd'>

<hibernate-mapping>
   <class
         name="org.alfresco.repo.domain.hibernate.IntegrityEventImpl"
         proxy="org.alfresco.repo.domain.IntegrityEvent"
         table="integrity_event"
         dynamic-update="false"
         dynamic-insert="false"
         select-before-update="false"
         optimistic-lock="version" >
      <cache usage="read-write"></cache>
      <id
            name="id"
            column="id"
            type="long" >
         <generator class="increment" />
      </id>
      <property name="transactionId" column="txn_id" length="36" not-null="true"/>
      <property name="eventType" column="event_type" length="36" not-null="true" />
      <property name="primaryNodeRef" column="primary_noderef" length="250" not-null="true"/>
      <property name="secondaryNodeRef" column="secondary_noderef" length="250" not-null="false"/>
      <property name="aspectTypeQName" column="aspect_type_qname" length="250" not-null="false"/>
      <property name="assocTypeQName" column="assoc_type_qname" length="250" not-null="false"/>
      <property name="assocQName" column="assoc_qname" length="250" not-null="false"/>
      <property name="trace" column="trace" type="serializable" length="16384" not-null="false"/>
   </class>

   <!-- get all events -->
   <query name="integrity.GetAllEvents">
      select
         event
      from
         org.alfresco.repo.domain.hibernate.IntegrityEventImpl as event
   </query>
   
   <!-- get all events for a transaction, including deletion events -->
   <query name="integrity.GetTxnEvents">
      select
         event
      from
         org.alfresco.repo.domain.hibernate.IntegrityEventImpl as event
      where
         event.transactionId = :transactionId
      order by
         event.primaryNodeRef,
         event.eventType
   </query>

   <!-- get all events for a transaction, but exclude all nodes that were deleted -->
   <query name="integrity.GetTxnEventsExDeleted">
      select
         event
      from
         org.alfresco.repo.domain.hibernate.IntegrityEventImpl as event
      where
         event.transactionId = :transactionId and
         event.primaryNodeRef not in
         (
            select
               deleted.primaryNodeRef
            from
               org.alfresco.repo.domain.hibernate.IntegrityEventImpl as deleted
            where
               deleted.transactionId = event.transactionId and
               deleted.eventType = 'nodeDeleted'
         )
      order by
         event.primaryNodeRef,
         event.eventType
   </query>
   
</hibernate-mapping>
