<project name="continuous" default="continuous">

   <!-- ********************************** -->
   <!-- ** Initialisation/Configuration ** -->
   <!-- ********************************** -->

   <property name="dir.common" value="${basedir}" />
   <import file="${dir.common}/common-init.xml" />

   <target name="init" depends="common-init.init">
      <property file="continuous.properties"/>
   </target>

   <!-- ************************************************************************* -->
   <!-- ** TODO: These targets need to also be aware of the enterprise project ** -->
   <!-- **       so that we can build both open and pro versions of the        ** -->
   <!-- **       bundles.                                                      ** -->
   <!-- ************************************************************************* -->

   <target name="continuous" description="Target called by the continuous build to create distribution bundles">
      <ant target="reset-database"/>
      <ant target="test"/>
      <antcall target="distribute"/>
   </target>

   <target name="nightly" description="Target called by the continuous build to create the nightly distribution">
      <ant target="reset-database"/>
      <ant target="test"/>
      <antcall target="package-source-distribution"/>
      <ant target="compile-docs"/>
   </target>

   <!-- ************************** -->
   <!-- ** Distribution targets ** -->
   <!-- ************************** -->

   <target name="distribute" 
           depends="package-jboss-binary-distribution,package-tomcat-binary-distribution,
                    package-source-distribution" 
           description="Creates the distribution files for all platforms for all appservers"/>

   <target name="package-jboss-binary-distribution" description="Creates the distibution files for JBoss">
      <ant target="clean-war"/>
      <ant target="incremental-jboss"/>
      <antcall target="package-jboss-binary-distribution-windows"/>
      <antcall target="package-jboss-binary-distribution-linux"/>
   </target>

   <target name="package-tomcat-binary-distribution" description="Creates the distibution files for Tomcat">
      <ant target="clean-war"/>
      <ant target="incremental-tomcat"/>
      <antcall target="package-tomcat-binary-distribution-windows"/>
      <antcall target="package-tomcat-binary-distribution-linux"/>
   </target>

   <target name="package-jboss-binary-distribution-windows" depends="init">
      <!-- make sure the MySQL connector is present and up to date -->
      <delete>
         <fileset dir="${dir.distribution.jboss}/server/default/lib" includes="mysql-connector*" excludes="${file.name.mysql.connector}"/>
      </delete>
      <copy todir="${dir.distribution.jboss}/server/default/lib" file="${dir.common.lib}/${file.name.mysql.connector}"/>
      <mkdir dir="${dir.dist}" />
      <zip destfile="${dir.dist}/${file.name.dist.bin.jboss}.zip">
         <zipfileset dir="${dir.project.installer}" 
                     includes="alf_start_jb.bat,alf_stop_jb.bat,AlfrescoTest.pdf,db_remove.bat,db_setup.bat,
                               licenses/**,README_jboss_win.txt,start_oo2.bat,*.sql, paths_jb.bat,
                               stop_oo.bat,zstart_oo.bat" />
         <zipfileset dir="${dir.distribution.jboss}" prefix="jboss" excludes="**/bin/*.sh" />
         <zipfileset dir="${dir.project.installer}/bin-win" prefix="bin"/>
         <zipfileset dir="${dir.project.netbios}/dll" prefix="bin"/>
         <zipfileset dir="${dir.project.webclient}/build/dist" prefix="jboss/server/default/deploy" 
                     includes="${file.name.war.alfresco}"/>
         <zipfileset dir="${dir.config.repository}" prefix="jboss/server/default/conf"/>
         <zipfileset dir="${dir.config.webclient}"  prefix="jboss/server/default/conf"/>
         <zipfileset file="${dir.common}/version.properties" prefix="jboss/server/default/conf/alfresco" />
      </zip>
   </target>

   <target name="package-jboss-binary-distribution-linux" depends="init">
      <!-- make sure the MySQL connector is present and up to date -->
      <delete>
         <fileset dir="${dir.distribution.jboss}/server/default/lib" includes="mysql-connector*" excludes="${file.name.mysql.connector}"/>
      </delete>
      <copy todir="${dir.distribution.jboss}/server/default/lib" file="${dir.common.lib}/${file.name.mysql.connector}"/>
      <mkdir dir="${dir.dist}" />
      <tar destfile="${dir.dist}/${file.name.dist.bin.jboss}.tar" longfile="gnu">
         <tarfileset dir="${dir.project.installer}" 
                     includes="AlfrescoTest.pdf,licenses/**,
                               *.sql,db_setup.sh,db_remove.sh,
                               README_jboss_linux.txt,start_oo.sh,stop_oo.sh,paths_jb.sh,alf_start_jb.sh,alf_stop_jb.sh,
                               README_jboss_osx.txt" />
         <tarfileset dir="${dir.distribution.jboss}" prefix="jboss" excludes="**/bin/*.bat" />
         <tarfileset dir="${dir.project.webclient}/build/dist" includes="${file.name.war.alfresco}"
                     prefix="jboss/server/default/deploy" />
         <tarfileset dir="${dir.config.repository}" prefix="jboss/server/default/conf" />
         <tarfileset dir="${dir.config.webclient}" prefix="jboss/server/default/conf" />
         <tarfileset file="${dir.common}/version.properties" prefix="jboss/server/default/conf/alfresco" />
      </tar>
      <gzip zipfile="${dir.dist}/${file.name.dist.bin.jboss}.tar.gz" src="${dir.dist}/${file.name.dist.bin.jboss}.tar" />
      <delete file="${dir.dist}/${file.name.dist.bin.jboss}.tar" />
   </target>

   <target name="package-tomcat-binary-distribution-windows" depends="init">
      <!-- make sure the MySQL connector is present and up to date -->
      <delete>
         <fileset dir="${dir.distribution.tomcat}/common/lib" includes="mysql-connector*" excludes="${file.name.mysql.connector}"/>
      </delete>
      <copy todir="${dir.distribution.tomcat}/common/lib" file="${dir.common.lib}/${file.name.mysql.connector}" />
      <mkdir dir="${dir.dist}" />
      <zip destfile="${dir.dist}/${file.name.dist.bin.tomcat}.zip">
         <zipfileset dir="${dir.project.installer}" 
                     includes="alf_start_tc.bat,alf_stop_tc.bat,AlfrescoTest.pdf,db_remove.bat,db_setup.bat,
                               licenses/**,README_tomcat_win.txt,start_oo2.bat,*.sql, paths_tc.bat,
                               stop_oo.bat,zstart_oo.bat" />
         <zipfileset dir="${dir.distribution.tomcat}" prefix="tomcat" excludes="**/bin/*.sh" />
         <zipfileset dir="${dir.project.installer}/bin-win" prefix="bin"/>
         <zipfileset dir="${dir.project.netbios}/dll" prefix="bin"/>
         <zipfileset dir="${dir.deploy.tomcat}" prefix="tomcat/webapps" includes="${file.name.war.alfresco}"/>
      </zip>
   </target>
   
   <target name="package-tomcat-binary-distribution-linux" depends="init">
      <!-- make sure the MySQL connector is present and up to date -->
      <delete>
         <fileset dir="${dir.distribution.tomcat}/common/lib" includes="mysql-connector*" excludes="${file.name.mysql.connector}"/>
      </delete>
      <copy todir="${dir.distribution.tomcat}/common/lib" file="${dir.common.lib}/${file.name.mysql.connector}" />
      <mkdir dir="${dir.dist}" />
      <tar destfile="${dir.dist}/${file.name.dist.bin.tomcat}.tar" longfile="gnu">
         <tarfileset dir="${dir.project.installer}"
                     includes="AlfrescoTest.pdf,licenses/**,
                               *.sql,db_setup.sh,db_remove.sh,
                               README_tomcat_linux.txt,start_oo.sh,stop_oo.sh,paths_tc.sh,alf_start_tc.sh,alf_stop_tc.sh,
                               README_tomcat_osx.txt" />
         <tarfileset dir="${dir.distribution.tomcat}" prefix="tomcat" excludes="**/bin/*.sh,**/bin/*.bat" />
         <tarfileset dir="${dir.distribution.tomcat}/bin" prefix="tomcat/bin" includes="*.sh" mode="755" />
         <tarfileset dir="${dir.deploy.tomcat}" prefix="tomcat/webapps" includes="${file.name.war.alfresco}"/>
      </tar>
      <gzip zipfile="${dir.dist}/${file.name.dist.bin.tomcat}.tar.gz" src="${dir.dist}/${file.name.dist.bin.tomcat}.tar" />
      <delete file="${dir.dist}/${file.name.dist.bin.tomcat}.tar" />
   </target>
   
   <target name="package-source-distribution" depends="init"
           description="Creates the source distribution file for all platforms">
      <mkdir dir="${dir.dist}" />
      <zip destfile="${dir.dist}/${file.name.dist.src}.zip">
         <zipfileset dir="${dir.common}" excludes="${dist.src.excludes}" />
      </zip>
      
      <tar destfile="${dir.dist}/${file.name.dist.src}.tar" longfile="gnu">
         <tarfileset dir="${dir.common}" excludes="${dist.src.excludes}" />
      </tar>
      <gzip zipfile="${dir.dist}/${file.name.dist.src}.tar.gz" src="${dir.dist}/${file.name.dist.src}.tar" />
      <delete file="${dir.dist}/${file.name.dist.src}.tar" />
   </target>

</project>
